<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .app-header { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center; }
    .main-content { max-width: 100%; margin: 20px auto; padding: 15px; display: none; }
    
    /* CONTAINER TABEL RESPONSIVE */
    .table-container { 
        background: white; 
        border-radius: 10px; 
        padding: 15px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        overflow: hidden; /* Wrapper utama */
    }

    .table-responsive {
        max-height: 70vh; /* Scroll Vertikal */
        overflow-x: auto; /* Scroll Horizontal */
        position: relative;
    }

    /* TABLE HEADER STICKY */
    thead th { 
      background-color: #212529 !important; 
      color: white !important; 
      white-space: nowrap; /* Header jangan wrap */
      text-align: center;
      vertical-align: middle;
      position: sticky; 
      top: 0;
      z-index: 10;
      border-top: none !important;
    }

    /* TABLE BODY */
    tbody td {
      white-space: nowrap; /* KUNCI: Nama tidak akan turun baris */
      vertical-align: middle;
      padding: 8px 10px;
    }
    
    /* NAMA SISWA (Kolom 2) STICKY DI KIRI (Opsional, biar enak dilihat di HP) */
    /* Hapus blok ini jika tidak ingin nama sticky */
    tbody td:nth-child(2), thead th:nth-child(2) {
        position: sticky;
        left: 0;
        z-index: 11; /* Di atas data lain */
        background-color: inherit; /* Ikuti warna baris */
    }
    thead th:nth-child(2) { z-index: 12; background-color: #212529 !important; } /* Header nama */

    /* UKURAN KOLOM MAPEL & NILAI SERAGAM */
    /* Target kolom ke-5 dst (Nilai Mapel) */
    th:nth-child(n+5), td:nth-child(n+5) {
       min-width: 60px;
       max-width: 60px;
       text-align: center;
    }
    
    /* Highlight Baris saat Hover */
    tbody tr:hover td {
        background-color: #e2e6ea !important; /* Warna hover */
    }

    /* Pagination Controls */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
    }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }

    /* Class untuk kolom yang menyesuaikan lebar konten (Auto-fit) */
    .col-fit {
        width: 1%;                 /* Trik agar kolom menyusut sekecil kontennya */
        white-space: nowrap;       /* Mencegah teks turun baris (wrapping) */
        min-width: auto !important; /* Override aturan min-width 60px sebelumnya */
        max-width: none !important; /* Override aturan max-width 60px sebelumnya */
        padding-left: 15px !important;
        padding-right: 15px !important;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loader">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>

<div class="container" id="view-login">
  <div class="card card-login">
    <div class="app-header">
      <h4><i class="fas fa-archive"></i> Arsip Nilai</h4>
      <p class="mb-0">Masuk dengan NPSN Sekolah</p>
    </div>
    <div class="card-body p-4">
      <form onsubmit="handleLogin(event)">
        <div class="mb-3">
          <label class="form-label">NPSN Sekolah</label>
          <input type="text" id="input-npsn" class="form-control form-control-lg text-center" placeholder="Contoh: 12345678" required>
        </div>
        <button type="submit" class="btn btn-primary w-100 btn-lg">Buka Arsip</button>
      </form>
      <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
    </div>
  </div>
</div>

<div class="main-content" id="view-dashboard">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 id="dash-nama-sekolah" class="text-primary fw-bold">Nama Sekolah</h3>
      <p class="text-muted mb-0">Arsip Rekapitulasi Nilai Tahunan</p>
    </div>
    <button class="btn btn-outline-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Keluar</button>
  </div>

  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body d-flex align-items-end gap-3 flex-wrap">
      
      <div style="min-width: 160px;">
        <label class="form-label fw-bold small">Mode Tampilan:</label>
        <select id="select-mode" class="form-select form-select-sm" onchange="toggleMode()">
          <option value="single">Per Tahun (Detail Siswa)</option>
          <option value="range">Rentang Tahun (Mapel)</option>
        </select>
      </div>

      <div id="filter-single" class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Pilih Tahun Arsip:</label>
        <select id="select-year" class="form-select form-select-sm" onchange="handleLoadData()">
          <option value="">-- Pilih Tahun --</option>
        </select>
      </div>

      <div id="filter-range" class="flex-grow-1 d-none d-flex gap-2" style="min-width: 300px;">
          <div class="flex-grow-1">
            <label class="form-label fw-bold small">Tahun Awal:</label>
            <select id="select-year-start" class="form-select form-select-sm">
               <option value="">-- Awal --</option>
            </select>
          </div>
          <div class="flex-grow-1">
            <label class="form-label fw-bold small">Tahun Akhir:</label>
            <select id="select-year-end" class="form-select form-select-sm">
               <option value="">-- Akhir --</option>
            </select>
          </div>
          <button class="btn btn-success btn-sm align-self-end" onclick="handleLoadData()" title="Tampilkan Data"><i class="fas fa-search"></i></button>
      </div>

      <div class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Jenis Nilai:</label>
        <select id="select-jenis" class="form-select form-select-sm" onchange="handleJenisChange()">
          <option value="Ijazah" selected>Nilai Ijazah (Akhir)</option>
          <option value="Ujian">Nilai Ujian (Murni)</option>
          <option value="Rapor">Nilai Rapor (Murni)</option>
        </select>
      </div>

      <div id="filter-search" class="flex-grow-1" style="min-width: 200px;">
         <label class="form-label fw-bold small">Cari Siswa:</label>
         <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Nama atau NISN..." onkeyup="handleSearch()">
      </div>
      
      <div id="filter-rows" style="min-width: 80px;">
         <label class="form-label fw-bold small">Baris:</label>
         <select id="rows-per-page" class="form-select form-select-sm" onchange="changePageSize()">
             <option value="25" selected>25</option>
             <option value="50">50</option>
             <option value="100">100</option>
             <option value="all">Semua</option>
         </select>
      </div>

    </div>
  </div>

  <div class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="table-title" class="mb-0 text-secondary">Data Arsip</h5>
    </div>
    
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="data-table">
        <thead id="table-head"></thead>
        <tbody id="table-body">
            <tr><td class="text-center text-muted p-4">Silakan pilih tahun arsip untuk melihat data.</td></tr>
        </tbody>
      </table>
    </div>

    <div id="pagination-controls" class="pagination-container" style="display:none;">
        <div class="text-muted small" id="page-info">Menampilkan 0-0 dari 0 data</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><button class="page-link" onclick="prevPage()" id="btn-prev">Sebelumnya</button></li>
                <li class="page-item active"><span class="page-link" id="current-page-label">1</span></li>
                <li class="page-item"><button class="page-link" onclick="nextPage()" id="btn-next">Berikutnya</button></li>
            </ul>
        </nav>
    </div>
  </div>
</div>

<style>
    /* --- TAMBAHAN CSS CLASS KHUSUS --- */
    .col-fit {
        width: 1%;
        white-space: nowrap;
        min-width: auto !important;
        max-width: none !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
    }
    .d-none { display: none !important; }
</style>

<script>
  let currentArsipDbId = null;
  let globalTableData = { headers: [], rows: [] }; 
  let filteredRows = []; 
  let currentPage = 1;
  let rowsPerPage = 25;

  function showLoader(show) {
    document.getElementById('loader').style.display = show ? 'flex' : 'none';
  }

  function handleLogin(e) {
    e.preventDefault();
    const npsn = document.getElementById('input-npsn').value;
    showLoader(true);
    document.getElementById('login-error').classList.add('d-none');
    
    google.script.run
      .withSuccessHandler(res => {
        showLoader(false);
        if (res.success) {
          currentArsipDbId = res.data.arsipDbId;
          document.getElementById('dash-nama-sekolah').innerText = res.data.namaSekolah;
          document.getElementById('view-login').style.display = 'none';
          document.getElementById('view-dashboard').style.display = 'block';
          loadYears();
        } else {
          const err = document.getElementById('login-error');
          err.innerText = res.message;
          err.classList.remove('d-none');
        }
      })
      .withFailureHandler(err => {
        showLoader(false);
        alert("Error: " + err.message);
      })
      .loginArsip(npsn);
  }

  function loadYears() {
    google.script.run.withSuccessHandler(res => {
      // Populate ketiga dropdown (Single, Start, End)
      const selects = ['select-year', 'select-year-start', 'select-year-end'];
      
      selects.forEach(id => {
         const select = document.getElementById(id);
         const defaultText = id === 'select-year' ? '-- Pilih Tahun --' : (id.includes('start') ? '-- Awal --' : '-- Akhir --');
         select.innerHTML = `<option value="">${defaultText}</option>`;
         
         if (res.success && res.years.length > 0) {
            res.years.forEach(year => {
              const opt = document.createElement('option');
              opt.value = year;
              opt.innerText = year.replace('Arsip ', '');
              select.appendChild(opt);
            });
         }
      });
    }).getArsipYears(currentArsipDbId);
  }

  // --- FUNGSI TOGGLE MODE TAMPILAN ---
  function toggleMode() {
      const mode = document.getElementById('select-mode').value;
      const singleFilter = document.getElementById('filter-single');
      const rangeFilter = document.getElementById('filter-range');
      const searchBox = document.getElementById('filter-search');
      const rowsBox = document.getElementById('filter-rows');

      // Reset Tabel
      document.getElementById('table-body').innerHTML = '<tr><td colspan="100%" class="text-center p-4 text-muted">Silakan pilih filter tahun.</td></tr>';
      document.getElementById('table-head').innerHTML = '';
      document.getElementById('pagination-controls').style.display = 'none';
      document.getElementById('table-title').innerText = 'Data Arsip';

      if (mode === 'single') {
          singleFilter.classList.remove('d-none');
          rangeFilter.classList.add('d-none');
          searchBox.classList.remove('d-none'); // Tampilkan search di mode Single
          rowsBox.style.display = 'block';
      } else {
          singleFilter.classList.add('d-none');
          rangeFilter.classList.remove('d-none');
          searchBox.classList.add('d-none'); // Sembunyikan search di mode Range
          rowsBox.style.display = 'none'; // Sembunyikan pagination setting di mode Range (data biasanya dikit)
      }
  }
  
  function handleJenisChange() {
     // Jika data sudah ada, muat ulang. Jika belum, biarkan.
     // Khusus untuk mode Single, kita bisa render ulang dari cache jika hanya ganti tampilan kolom.
     // Tapi untuk mode Range, kita PERLU request server baru karena datanya diagregasi berdasarkan jenis.
     const mode = document.getElementById('select-mode').value;
     if (mode === 'single') {
         if (globalTableData.rows.length > 0) renderTableFromCache(); // Render ulang (kolom berubah)
     } else {
         handleLoadData(); // Request ulang
     }
  }

  function handleLoadData() {
    const mode = document.getElementById('select-mode').value;
    const jenis = document.getElementById('select-jenis').value;

    if (mode === 'single') {
        const sheetName = document.getElementById('select-year').value;
        if (!sheetName) return;
        
        showLoader(true);
        document.getElementById('table-title').innerText = "Data Arsip: " + sheetName.replace('Arsip ', '');
        
        google.script.run.withSuccessHandler(res => {
          showLoader(false);
          if (res.success) {
            globalTableData.headers = res.headers;
            globalTableData.rows = res.rows;
            filteredRows = res.rows;
            currentPage = 1;
            renderTableFromCache();
          } else {
            alert("Gagal memuat data: " + res.message);
          }
        }).getArsipData(currentArsipDbId, sheetName);
        
    } else {
        // MODE RANGE
        const startSheet = document.getElementById('select-year-start').value;
        const endSheet = document.getElementById('select-year-end').value;
        
        if (!startSheet || !endSheet) {
            // Jangan load jika belum lengkap, atau beri alert
            return;
        }

        showLoader(true);
        document.getElementById('table-title').innerText = `Rekapitulasi Nilai (${jenis}) Rentang Tahun`;
        
        google.script.run.withSuccessHandler(res => {
            showLoader(false);
            if (res.success) {
                globalTableData.headers = res.headers;
                globalTableData.rows = res.rows;
                filteredRows = res.rows;
                // Render khusus untuk Range
                renderRangeTable();
            } else {
                alert("Gagal: " + res.message);
            }
        }).getArsipDataRange(currentArsipDbId, startSheet, endSheet, jenis);
    }
  }
  
  // --- RENDER TABEL MODE RANGE (BARU) ---
  function renderRangeTable() {
      const headers = globalTableData.headers;
      const rows = globalTableData.rows;
      const thead = document.getElementById('table-head');
      const tbody = document.getElementById('table-body');
      const paginationDiv = document.getElementById('pagination-controls');
      
      thead.innerHTML = '';
      tbody.innerHTML = '';
      paginationDiv.style.display = 'none'; // Tidak perlu paginasi

      // 1. Header
      let headerHtml = '<tr>';
      headers.forEach(h => {
          let style = '';
          if (h === 'Jumlah' || h === 'Rata-Rata') {
               style = 'style="background-color: #0d6efd !important;" class="col-fit"';
          }
          headerHtml += `<th ${style}>${h}</th>`;
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;
      
      // 2. Body
      if (rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">Tidak ada data.</td></tr>';
          return;
      }

      rows.forEach(row => {
          let rowHtml = '<tr>';
          row.forEach((cell, idx) => {
              // Cek nama kolom untuk styling
              const colName = headers[idx];
              let cellStyle = '';
              let cellContent = cell;
              
              if (colName === 'Jumlah' || colName === 'Rata-Rata') {
                  cellContent = `<strong>${cell}</strong>`;
                  cellStyle = 'class="col-fit"';
              }
              rowHtml += `<td ${cellStyle}>${cellContent}</td>`;
          });
          rowHtml += '</tr>';
          tbody.innerHTML += rowHtml;
      });
  }

  // --- RENDER TABEL MODE SINGLE (LOGIKA SEBELUMNYA) ---
  function renderTableFromCache() {
    // Cek apakah kita di mode Range secara tidak sengaja (misal switch tab tanpa reload)
    // Jika header pertama adalah "Tahun Pelajaran", lempar ke renderRangeTable
    if (globalTableData.headers[0] === 'Tahun Pelajaran') {
        renderRangeTable();
        return;
    }

    const jenis = document.getElementById('select-jenis').value; 
    const rawHeaders = globalTableData.headers;
    
    const thead = document.getElementById('table-head');
    const tbody = document.getElementById('table-body');
    const paginationDiv = document.getElementById('pagination-controls');
    
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (filteredRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">Data kosong.</td></tr>';
        paginationDiv.style.display = 'none';
        return;
    }

    // Identifikasi Index
    const indicesMapel = [];
    let indexJumlah = -1;
    let indexRata = -1;
    const statusIndex = rawHeaders.length - 1;
    
    for (let i = 4; i < rawHeaders.length - 1; i++) { 
        const h = rawHeaders[i];
        if (h === 'Jumlah_' + jenis) indexJumlah = i;
        else if (h === 'Rata_' + jenis) indexRata = i;
        else if (h.endsWith('_' + jenis) && !h.startsWith('Jumlah_') && !h.startsWith('Rata_')) {
            indicesMapel.push(i);
        }
    }
    
    // Render Header
    let headerHtml = '<tr>';
    for(let k=0; k<4; k++) headerHtml += `<th>${rawHeaders[k]}</th>`; // Info Dasar

    indicesMapel.forEach(idx => {
        let displayH = rawHeaders[idx].replace('_' + jenis, '');
        headerHtml += `<th>${displayH}</th>`;
    });

    headerHtml += `<th class="col-fit" style="background-color: #0d6efd !important;">Jumlah</th>`;
    headerHtml += `<th class="col-fit" style="background-color: #0d6efd !important;">Rata-Rata</th>`;
    headerHtml += `<th class="col-fit">Status</th>`;
    headerHtml += '</tr>';
    thead.innerHTML = headerHtml;

    // Paginasi
    const totalRows = filteredRows.length;
    let startIdx = 0;
    let endIdx = totalRows;

    if (rowsPerPage !== 'all') {
        const pageSize = parseInt(rowsPerPage);
        startIdx = (currentPage - 1) * pageSize;
        endIdx = Math.min(startIdx + pageSize, totalRows);
    }

    const rowsToRender = filteredRows.slice(startIdx, endIdx);

    // Render Body
    rowsToRender.forEach(row => {
        let rowHtml = '<tr>';
        for(let k=0; k<4; k++) rowHtml += `<td>${row[k] || ''}</td>`;

        let calculatedSum = 0;
        let countVal = 0;

        indicesMapel.forEach(idx => {
            let cellVal = row[idx];
            let num = parseFloat(cellVal);
            if (!isNaN(num)) {
                calculatedSum += num;
                countVal++;
            }
            rowHtml += `<td>${cellVal || ''}</td>`;
        });

        let valJumlah = '';
        if (indexJumlah !== -1 && row[indexJumlah] !== undefined && row[indexJumlah] !== '') {
            valJumlah = row[indexJumlah];
        } else {
            if (countVal > 0) {
                valJumlah = (jenis === 'Ijazah') ? Math.round(calculatedSum) : parseFloat(calculatedSum).toFixed(2);
            } else { valJumlah = 0; }
        }
        rowHtml += `<td class="col-fit"><strong>${valJumlah}</strong></td>`;

        let valRata = '';
        if (indexRata !== -1 && row[indexRata] !== undefined && row[indexRata] !== '') {
            valRata = row[indexRata];
        } else {
             valRata = countVal > 0 ? (calculatedSum / countVal).toFixed(2) : "0.00";
        }
        rowHtml += `<td class="col-fit"><strong>${valRata}</strong></td>`;

        let valStatus = row[statusIndex] || '';
        let badgeClass = 'bg-secondary';
        if (valStatus === 'LULUS') badgeClass = 'bg-success';
        else if (valStatus === 'TIDAK LULUS') badgeClass = 'bg-danger';
        rowHtml += `<td class="col-fit"><span class="badge ${badgeClass}">${valStatus}</span></td>`;

        rowHtml += '</tr>';
        tbody.innerHTML += rowHtml;
    });
    
    updatePaginationInfo(totalRows, startIdx, endIdx);
  }

  // Fungsi utilitas lain (Search, Pagination, Logout) tetap sama...
  function handleSearch() {
    const input = document.getElementById('search-input').value.toLowerCase();
    if (input.length < 1) {
        filteredRows = globalTableData.rows;
    } else {
        filteredRows = globalTableData.rows.filter(row => {
            const nama = (row[1] || '').toString().toLowerCase();
            const nisn = (row[2] || '').toString().toLowerCase();
            return nama.includes(input) || nisn.includes(input);
        });
    }
    currentPage = 1;
    renderTableFromCache();
  }

  function changePageSize() {
    rowsPerPage = document.getElementById('rows-per-page').value;
    currentPage = 1;
    renderTableFromCache();
  }

  function nextPage() {
    if (rowsPerPage === 'all') return;
    const maxPage = Math.ceil(filteredRows.length / parseInt(rowsPerPage));
    if (currentPage < maxPage) {
        currentPage++;
        renderTableFromCache();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderTableFromCache();
    }
  }

  function updatePaginationInfo(total, start, end) {
    const paginationDiv = document.getElementById('pagination-controls');
    const pageInfo = document.getElementById('page-info');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageLabel = document.getElementById('current-page-label');

    if (total === 0) {
        paginationDiv.style.display = 'none';
        return;
    }
    paginationDiv.style.display = 'flex';

    if (rowsPerPage === 'all') {
        pageInfo.innerText = `Menampilkan semua ${total} data`;
        btnPrev.parentElement.classList.add('disabled');
        btnNext.parentElement.classList.add('disabled');
        pageLabel.innerText = '1';
    } else {
        pageInfo.innerText = `Menampilkan ${start + 1}-${end} dari ${total} data`;
        const maxPage = Math.ceil(total / parseInt(rowsPerPage));
        pageLabel.innerText = `${currentPage} / ${maxPage}`;
        if (currentPage === 1) btnPrev.parentElement.classList.add('disabled');
        else btnPrev.parentElement.classList.remove('disabled');
        if (currentPage === maxPage) btnNext.parentElement.classList.add('disabled');
        else btnNext.parentElement.classList.remove('disabled');
    }
  }

  function logout() {
    location.reload();
  }
</script>
</body>
</html>
