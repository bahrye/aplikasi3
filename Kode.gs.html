const ID_MASTER_SHEET_APP_1 = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 

// --- FUNGSI PEMICU IZIN (JANGAN DIHAPUS) ---
function _triggerDrivePermission() {
  DriveApp.getFiles();
}

function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Arsip Nilai Sekolah')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .setFaviconUrl("https://images.icon-icons.com/1147/PNG/512/1486486315-archive-archives-files-hosting-database-server-storage_81222.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

function loginArsip(npsn) {
  try {
    if (!npsn) throw new Error("NPSN wajib diisi.");
    
    // CACHE LOGIN: Cek apakah info sekolah untuk NPSN ini ada di cache
    const cache = CacheService.getScriptCache();
    const cacheKey = "LOGIN_ARSIP_" + npsn;
    const cachedData = cache.get(cacheKey);
    
    if (cachedData) {
       return { success: true, data: JSON.parse(cachedData) };
    }

    const masterSS = SpreadsheetApp.openById(ID_MASTER_SHEET_APP_1);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();
    
    let sekolahInfo = null;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][7]).trim() === String(npsn).trim()) { // Kolom H = NPSN
        sekolahInfo = {
          namaSekolah: data[i][1],
          arsipDbId: data[i][21] // Kolom V = Arsip_DB_ID
        };
        break;
      }
    }
    
    if (!sekolahInfo) throw new Error("NPSN tidak ditemukan.");
    if (!sekolahInfo.arsipDbId) throw new Error("Sekolah ini belum memiliki Arsip Nilai.");
    
    // Simpan hasil login ke cache selama 6 jam
    cache.put(cacheKey, JSON.stringify(sekolahInfo), 21600);

    return { success: true, data: sekolahInfo };
    
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipYears(arsipDbId) {
  try {
    // --- PERBAIKAN: HAPUS CACHE ---
    // Kita menghapus logika cache di sini agar setiap kali dibuka, 
    // aplikasi selalu mengecek sheet terbaru yang ada di Spreadsheet.
    
    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheets = ss.getSheets();
    const years = [];
    
    sheets.forEach(sheet => {
      const name = sheet.getName();
      if (name.startsWith("Arsip ")) {
        years.push(name);
      }
    });
    
    // Urutkan tahun terbaru di atas
    years.sort().reverse();
    
    return { success: true, years: years };
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipData(arsipDbId, sheetName) {
  try {
    // CACHE DATA: Ini yang paling penting untuk mencegah Error 429
    const cache = CacheService.getScriptCache();
    const cacheKey = "DATA_" + arsipDbId + "_" + sheetName;
    const cachedData = cache.get(cacheKey);

    if (cachedData) {
      return JSON.parse(cachedData); // Return langsung tanpa buka Spreadsheet
    }

    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error("Data tahun tersebut tidak ditemukan.");
    
    const data = sheet.getDataRange().getDisplayValues();
    const headers = data.shift();
    
    const result = { success: true, headers: headers, rows: data };

    // Simpan ke cache. Gunakan try-catch karena limit cache per item adalah 100KB.
    try {
      cache.put(cacheKey, JSON.stringify(result), 21600);
    } catch (err) {
      Logger.log("Data terlalu besar untuk cache: " + err.message);
    }

    return result;
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipDataRange(arsipDbId, startSheet, endSheet, jenisNilai) {
  // Fungsi Range ini kompleks, kita cache hasil akhirnya
  const cache = CacheService.getScriptCache();
  const cacheKey = "RANGE_" + arsipDbId + "_" + startSheet + "_" + endSheet + "_" + jenisNilai;
  const cachedData = cache.get(cacheKey);

  if (cachedData) {
     return JSON.parse(cachedData);
  }

  try {
    const ss = SpreadsheetApp.openById(arsipDbId);
    const allSheets = ss.getSheets();
    const arsipSheets = [];
    
    allSheets.forEach(s => {
      const name = s.getName();
      if (name.startsWith("Arsip ")) arsipSheets.push(name);
    });
    arsipSheets.sort();
    
    const startIndex = arsipSheets.indexOf(startSheet);
    const endIndex = arsipSheets.indexOf(endSheet);
    
    if (startIndex === -1 || endIndex === -1) throw new Error("Tahun awal atau akhir tidak valid.");
    
    const start = Math.min(startIndex, endIndex);
    const end = Math.max(startIndex, endIndex);
    const targetSheets = arsipSheets.slice(start, end + 1);
    
    const suffix = "_" + jenisNilai;
    const rowsResult = [];
    const allMapels = new Set();
    
    targetSheets.forEach(sheetName => {
       const sheet = ss.getSheetByName(sheetName);
       const data = sheet.getDataRange().getValues();
       if (data.length <= 1) return;

       const headers = data.shift();
       const mapelIndices = {}; 
       headers.forEach((h, i) => {
         if (h.endsWith(suffix)) {
           const mapel = h.replace(suffix, '');
           if (mapel !== 'Jumlah' && mapel !== 'Rata') {
             mapelIndices[mapel] = i;
             allMapels.add(mapel);
           }
         }
       });
       
       const sums = {};
       const counts = {};
       let studentCount = 0;
       
       data.forEach(row => {
         studentCount++;
         for (const [m, idx] of Object.entries(mapelIndices)) {
            const val = row[idx];
            if (val !== "" && val !== null && !isNaN(val)) {
               sums[m] = (sums[m] || 0) + Number(val);
               counts[m] = (counts[m] || 0) + 1;
            }
         }
       });
       
       const rowData = {
         'Tahun Pelajaran': sheetName.replace('Arsip ', ''),
         '_meta_student_count': studentCount
       };
       
       let totalAvgSum = 0;
       let mapelCount = 0;
       
       for (const [m, sum] of Object.entries(sums)) {
          const count = counts[m] || 0;
          if (count > 0) {
             const avg = sum / count;
             rowData[m] = avg;
             totalAvgSum += avg;
             mapelCount++;
          }
       }
       
       rowData['Jumlah'] = totalAvgSum;
       rowData['Rata-Rata'] = mapelCount > 0 ? (totalAvgSum / mapelCount) : 0;
       rowsResult.push(rowData);
    });
    
    const sortedMapels = Array.from(allMapels).sort();
    const finalHeaders = ['Tahun Pelajaran', ...sortedMapels, 'Jumlah', 'Rata-Rata'];
    
    const finalRows = rowsResult.map(r => {
       return finalHeaders.map(h => {
          const val = r[h];
          if (typeof val === 'number') return val.toFixed(2);
          return val || '';
       });
    });
    
    const result = { success: true, headers: finalHeaders, rows: finalRows };
    
    // Cache hasil kalkulasi
    try { cache.put(cacheKey, JSON.stringify(result), 21600); } catch(e){}

    return result;
    
  } catch (e) {
    return { success: false, message: e.message };
  }
}

// --- OPTIMASI UNTUK MENCEGAH ERROR 429 (DROPDOWN PDF) ---
function getArsipDropdownData(arsipDbId, sheetName) {
  // CACHE DROPDOWN
  const cache = CacheService.getScriptCache();
  const cacheKey = "DROPDOWN_" + arsipDbId + "_" + sheetName;
  const cachedData = cache.get(cacheKey);

  if (cachedData) {
    return JSON.parse(cachedData);
  }

  try {
    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error("Data tahun tersebut tidak ditemukan.");
    
    const data = sheet.getDataRange().getValues();
    if (data.length === 0) return { success: true, mapels: [], classes: [] };
    
    const headers = data[0];
    
    // 1. Proses Mapel
    const mapelSet = new Set();
    const ignoreHeaders = [
      'No', 'Nama Siswa', 'NISN', 'Kelas', 'Status', 
      'Jumlah_Ujian', 'Jumlah_Rapor', 'Jumlah_Ijazah', 
      'Rata_Ujian', 'Rata_Rapor', 'Rata_Ijazah'
    ];
    
    headers.forEach(h => {
      if (h && !ignoreHeaders.includes(h)) {
        const lastUnderscore = h.lastIndexOf('_');
        if (lastUnderscore > 0) {
          const mapelName = h.substring(0, lastUnderscore);
          if (mapelName.length > 1) {
            mapelSet.add(mapelName);
          }
        }
      }
    });

    // 2. Proses Kelas
    const idxKelas = headers.indexOf('Kelas');
    const classSet = new Set();
    
    if (idxKelas !== -1 && data.length > 1) {
      for (let i = 1; i < data.length; i++) {
        const k = data[i][idxKelas];
        if (k) classSet.add(k);
      }
    }
    
    const result = { 
      success: true, 
      mapels: Array.from(mapelSet).sort(), 
      classes: Array.from(classSet).sort() 
    };

    // Simpan Cache
    cache.put(cacheKey, JSON.stringify(result), 21600);

    return result;

  } catch (e) {
    return { success: false, message: e.message };
  }
}

// --- GENERATE PDF (REVISI: HAPUS GARIS KOP OTOMATIS) ---
function generateArsipPdf(npsn, sheetName, mapel, jenisNilai, filterKelas) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(30000); 

    // 1. AMBIL DATA DARI MASTER SHEET (Cari Sekolah berdasarkan NPSN)
    const masterSS = SpreadsheetApp.openById(ID_MASTER_SHEET_APP_1);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataMaster = sheetSekolah.getDataRange().getValues();
    let rowData = null;
    
    // Cari baris berdasarkan NPSN (Kolom H / Index 7)
    for(let i=1; i<dataMaster.length; i++) {
      if (String(dataMaster[i][7]).trim() === String(npsn).trim()) {
        rowData = dataMaster[i];
        break;
      }
    }
    
    if (!rowData) throw new Error("Data sekolah tidak ditemukan (NPSN tidak cocok).");

    // 2. DEFINISI VARIABEL DARI MASTER SHEET
    const namaSekolah = rowData[1] || 'SEKOLAH';         // Kolom B
    const app1DbId = rowData[5];                         // Kolom F (ID DB App 1)
    const kopFileId = rowData[15];                       // Kolom P (ID File Kop Surat)
    const tempatTtdMaster = rowData[19];                 // Kolom T (Tempat TTD)
    const arsipDbId = rowData[21];                       // Kolom V (ID DB Arsip)
    
    // Logika Tanggal (Manual vs Otomatis)
    const tglManual = rowData[16]; // Kolom Q
    const modeTgl = rowData[20];   // Kolom U
    
    let tanggalStr = '';
    let dateObj = new Date(); // Default hari ini

    if (modeTgl === 'manual' && tglManual instanceof Date) {
        dateObj = tglManual;
    }
    // Format Tanggal Indonesia
    tanggalStr = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

    // 3. AMBIL DATA DARI DB APLIKASI 1 (Kepsek & Nama Mapel Lengkap)
    let kepalaSekolah = '.........................';
    let nipKepsek = '-';
    let jenjang = '';
    let mapelFullName = mapel; 
    
    // Prioritas Tempat TTD: Ambil dari Master Sheet dulu, jika kosong baru "-"
    let tempatTtdFinal = tempatTtdMaster ? tempatTtdMaster : "................";

    if (app1DbId) {
       // Blok A: Ambil Data Sekolah (Kepsek)
       try {
         const ss1 = SpreadsheetApp.openById(app1DbId);
         const dsSheet = ss1.getSheetByName('Data_Sekolah');
         if (dsSheet) {
           const val = dsSheet.getRange('A2:P2').getValues()[0];
           if(val[0]) jenjang = val[0];
           if(val[14]) kepalaSekolah = val[14]; 
           if(val[15]) nipKepsek = val[15];     
         }
       } catch(e) { 
         Logger.log("Gagal ambil data Kepsek dari App 1: " + e.message); 
       }

       // Blok B: Ambil Nama Mapel Lengkap
       try {
         const ss1 = SpreadsheetApp.openById(app1DbId); 
         const mapelSheetRef = ss1.getSheetByName('Mapel');
         if (mapelSheetRef) {
             const dataMapelRef = mapelSheetRef.getDataRange().getValues();
             for(let m=1; m < dataMapelRef.length; m++) {
                 if (String(dataMapelRef[m][0]).trim() === String(mapel).trim()) {
                     mapelFullName = dataMapelRef[m][1];
                     break;
                 }
             }
         }
       } catch(e) {
         Logger.log("Gagal ambil nama mapel dari App 1: " + e.message);
       }
    }

    // 4. AMBIL DATA NILAI DARI ARSIP (App 3)
    const ssArsip = SpreadsheetApp.openById(arsipDbId);
    const sheet = ssArsip.getSheetByName(sheetName);
    if (!sheet) throw new Error("Sheet Arsip tidak ditemukan.");

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const idxNo = headers.indexOf('No');
    const idxNama = headers.indexOf('Nama Siswa');
    const idxNisn = headers.indexOf('NISN');
    const idxKelas = headers.indexOf('Kelas');
    const colTarget = `${mapel}_${jenisNilai}`; 
    const idxNilai = headers.indexOf(colTarget);
    
    if (idxNilai === -1) throw new Error(`Data nilai '${colTarget}' tidak ditemukan di arsip.`);
    
    const siswaList = [];
    for (let i = 1; i < data.length; i++) {
       const row = data[i];
       const kelasSiswa = row[idxKelas];
       
       if (filterKelas !== 'semua' && String(kelasSiswa) !== String(filterKelas)) continue;
       
       const nilaiRaw = row[idxNilai];
       let nilaiAngka = '';
       let nilaiHuruf = '';
       
       if (nilaiRaw !== "" && nilaiRaw != null) {
          const num = parseFloat(nilaiRaw);
          nilaiAngka = Math.round(num);
          nilaiHuruf = terbilang(nilaiAngka);
       }
       
       siswaList.push({
         no: row[idxNo],
         nama: row[idxNama],
         nisn: row[idxNisn] ? String(row[idxNisn]).replace("'", "") : "-",
         kelas: kelasSiswa,
         nilai: nilaiAngka,
         huruf: nilaiHuruf
       });
    }
    
    siswaList.sort((a, b) => {
       if (a.kelas < b.kelas) return -1;
       if (a.kelas > b.kelas) return 1;
       return a.nama.localeCompare(b.nama);
    });

    // 5. SUSUN HTML UNTUK PDF
    
    // A. Header / Kop Surat
    let kopBase64 = null;
    if (kopFileId) {
        kopBase64 = _getImageAsBase64DataUrl(kopFileId);
    }

    let headerHtml = '';
    if (kopBase64) {
      // --- PERUBAHAN DI SINI: MENGHAPUS BORDER-BOTTOM ---
      // Saya menghapus 'border-bottom: 3px solid black;' karena gambar sudah punya garis.
      headerHtml = `
        <div style="width:100%; text-align:center; margin-bottom:5px; padding-bottom:0px;">
           <img src="${kopBase64}" style="width:100%; max-height:160px; object-fit:contain;" />
        </div>`;
    } else {
      // Fallback (Teks Saja) -> Tetap pakai garis
      headerHtml = `
        <div style="text-align: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px;">
           <h2 style="margin:0;">${namaSekolah.toUpperCase()}</h2>
        </div>`;
    }
      
    // B. Baris Data Siswa
    let rowsHtml = '';
    if (siswaList.length === 0) {
      rowsHtml = '<tr><td colspan="6" style="text-align:center; padding:20px;">Tidak ada data untuk filter ini.</td></tr>';
    } else {
      siswaList.forEach((s, i) => {
        rowsHtml += `<tr>
          <td style="text-align:center;">${i+1}</td>
          <td style="text-align:center;">${s.nisn}</td>
          <td style="text-align:left; padding-left:5px;">${s.nama}</td>
          <td style="text-align:center;">${s.kelas}</td>
          <td style="text-align:center;">${s.nilai}</td>
          <td style="text-align:left; padding-left:5px; font-style:italic;">${s.huruf}</td>
        </tr>`;
      });
    }
    
    // C. Info Footer
    const jabatan = (jenjang.includes('M') || jenjang.includes('MTS') || jenjang.includes('MA')) ? "Kepala Madrasah" : "Kepala Sekolah";
    const tahunAjar = sheetName.replace('Arsip ', '');
    const kepsekFormatted = formatNamaGelar(kepalaSekolah);
    const labelNilaiTitle = (jenisNilai === 'Ujian') ? 'UJIAN' : (jenisNilai === 'Rapor' ? 'RAPOR' : 'IJAZAH');

    // --- [MODIFIKASI FINAL] STYLE KUAT UNTUK MEMAKSA WARNA ---
    const styleHeader = 'style="background-color: #666666 !important; color: #ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; text-align: center; font-weight: bold; border: 1px solid black; padding: 6px;"';

    const html = `
      <html><head><style>
        @page { size: A4; margin: 1cm; }
        body { font-family: Arial, sans-serif; font-size: 10pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 4px; }
        
        /* Pastikan header tabel berwarna abu-abu gelap saat dicetak */
        th { 
            background-color: #666666 !important; 
            color: #ffffff !important; 
            text-align: center; 
            font-weight: bold;
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }

        .info-table { border: none; margin-bottom: 15px; width: 100%; font-size: 11pt; }
        .info-table td { border: none; padding: 3px; vertical-align: top;}
      </style></head><body>
        ${headerHtml}
        <div style="text-align:center; margin-bottom:20px;">
           <h3 style="text-decoration:underline; margin:5px;">LAPORAN NILAI ${labelNilaiTitle} (ARSIP)</h3>
           <h4 style="margin:5px; font-weight:bold;">${namaSekolah.toUpperCase()}</h4>
           <p style="margin:0;">Tahun Ajaran: ${tahunAjar}</p>
        </div>
        
        <table class="info-table">
           <tr>
             <td width="130">Mata Pelajaran</td>
             <td width="10">:</td>
             <td><strong>${mapelFullName.toUpperCase()}</strong></td>
           </tr>
           <tr>
             <td>Kelas</td>
             <td>:</td>
             <td><strong>${filterKelas === 'semua' ? 'Semua Kelas' : filterKelas}</strong></td>
           </tr>
        </table>

        <table>
           <thead>
             <tr>
               <th width="30" ${styleHeader}>No</th>
               <th width="80" ${styleHeader}>NISN</th>
               <th ${styleHeader}>Nama Siswa</th>
               <th width="60" ${styleHeader}>Kelas</th>
               <th width="50" ${styleHeader}>Nilai</th>
               <th ${styleHeader}>Terbilang</th>
             </tr>
           </thead>
           <tbody>${rowsHtml}</tbody>
        </table>

        <div style="margin-top:40px; float:right; width:250px; text-align:center;">
           ${tempatTtdFinal}, ${tanggalStr}<br>
           Mengetahui,<br>
           ${jabatan}
           <br><br><br><br>
           <strong><u>${kepsekFormatted}</u></strong><br>
           NIP. ${nipKepsek}
        </div>
      </body></html>
    `;
    
    const blob = Utilities.newBlob(html, MimeType.HTML).getAs(MimeType.PDF);
    const b64 = Utilities.base64Encode(blob.getBytes());
    return { success: true, base64Data: b64, fileName: `Arsip_${mapel}_${jenisNilai}_${tahunAjar}.pdf` };

  } catch (e) {
    return { success: false, message: e.message };
  } finally {
    lock.releaseLock();
  }
}

// --- HELPER UTILS (Sama dengan App 2) ---
function _getImageAsBase64DataUrl(fileId) {
  try {
    if (!fileId) return null;
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    const contentType = blob.getContentType();
    const base64 = Utilities.base64Encode(blob.getBytes());
    return `data:${contentType};base64,${base64}`;
  } catch (e) {
    Logger.log(`Gagal mengambil gambar (ID: ${fileId}). Error: ${e.message}`);
    return null;
  }
}

function terbilang(n) {
    if (n < 0 || n > 100 || isNaN(n) || n === '') return '';
    if (n === 100) return 'Seratus';
    if (n === 0) return 'Nol';
    const s = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
    if (n < 12) return s[n];
    if (n < 20) return s[n - 10] + " Belas";
    const p = Math.floor(n / 10);
    const r = n % 10;
    return (s[p] + " Puluh") + (r === 0 ? '' : " " + s[r]);
}

function properCaseGelar(gelarString) {
  if (!gelarString) return '';
  const joiner = gelarString.includes('.') ? ' ' : '.'; 
  return gelarString.split(' ') 
    .map(gelarPart => {
      return gelarPart.split('.') 
        .map(subPart => {
          if (subPart.length === 0) return ''; 
          if (subPart === subPart.toUpperCase()) return subPart; 
          if (subPart.length === 1) return subPart.toUpperCase(); 
          return subPart.charAt(0).toUpperCase() + subPart.slice(1).toLowerCase(); 
        })
        .join('.'); 
    })
    .join(' '); 
}

function formatNamaGelar(namaLengkap) {
  if (!namaLengkap) return '';
  namaLengkap = namaLengkap.trim();
  
  let nama = '';
  let gelar = '';
  
  const commaIndex = namaLengkap.indexOf(',');
  
  if (commaIndex > -1) {
    nama = namaLengkap.substring(0, commaIndex).trim();
    gelar = namaLengkap.substring(commaIndex + 1).trim();
  } else {
    const parts = namaLengkap.split(' ');
    if (parts.length < 2) return namaLengkap.toUpperCase();
    
    let titleStartIndex = -1;
    for (let i = 1; i < parts.length; i++) {
      const part = parts[i];
      const isGelar = part.includes('.') || 
                      (part.length >= 1 && part.length <= 3 && part === part.toUpperCase());
                      
      if (isGelar) {
        titleStartIndex = i;
        break;
      }
    }

    if (titleStartIndex > -1) {
      nama = parts.slice(0, titleStartIndex).join(' ');
      gelar = parts.slice(titleStartIndex).join(' ');
    } else {
      nama = namaLengkap;
      gelar = '';
    }
  }

  if (gelar) {
    return nama.toUpperCase() + ', ' + properCaseGelar(gelar);
  } else {
    return nama.toUpperCase();
  }
}

/**
 * [DIPERBARUI] Fungsi Utama Export Arsip (Excel & PDF)
 * PERBAIKAN: Mengambil legenda mapel dan mengirimkannya ke fungsi PDF.
 */
function processExportArsip(params) {
  try {
    let headers = [];
    let rows = [];
    let fileName = "";
    
    // 1. Ambil Data Arsip
    if (params.mode === 'single') {
      const data = getArsipData(params.arsipDbId, params.sheetName);
      if (!data.success) throw new Error(data.message);
      
      const rawHeaders = data.headers;
      const rawRows = data.rows;
      const jenis = params.jenisNilai;

      const indicesToKeep = [];
      const cleanHeaders = [];

      rawHeaders.forEach((h, index) => {
        if (['No', 'Nama Siswa', 'NISN', 'Kelas'].includes(h)) {
          indicesToKeep.push(index);
          cleanHeaders.push(h);
        }
        else if (h === 'Status') {
          if (jenis === 'Ijazah') {
             indicesToKeep.push(index);
             cleanHeaders.push(h);
          }
        }
        else if (h === `Jumlah_${jenis}`) {
          indicesToKeep.push(index);
          cleanHeaders.push("Jumlah");
        } 
        else if (h === `Rata_${jenis}`) {
          indicesToKeep.push(index);
          cleanHeaders.push("Rata-Rata");
        } 
        else if (h.endsWith(`_${jenis}`)) {
          indicesToKeep.push(index);
          cleanHeaders.push(h.replace(`_${jenis}`, ''));
        }
      });

      const filteredRows = rawRows.map(row => {
        return indicesToKeep.map(i => row[i]);
      });

      headers = cleanHeaders;
      rows = filteredRows;
      fileName = `Arsip_${params.sheetName}_${params.jenisNilai}_${params.namaSekolah}`;
    } 
    else if (params.mode === 'range') {
      const data = getArsipDataRange(params.arsipDbId, params.startSheet, params.endSheet, params.jenisNilai);
      if (!data.success) throw new Error(data.message);
      headers = data.headers;
      rows = data.rows;
      fileName = `Rekap_Rentang_${params.jenisNilai}_${params.namaSekolah}`;
    }
    
    if (rows.length === 0) throw new Error("Tidak ada data untuk diekspor.");

    // 2. Generate File
    if (params.type === 'excel') {
      return generateExcelArsip(headers, rows, fileName, params.title, params.namaSekolah);
    } else {
      // [PERBAIKAN] Ambil legenda mapel untuk PDF
      const legend = getMapelLegend(params.arsipDbId);
      return generatePdfArsip(headers, rows, fileName, params.title, params.namaSekolah, params.mode, legend);
    }

  } catch (e) {
    return { success: false, message: e.message };
  }
}

/**
 * [HELPER] Generate Excel Blob
 */
function generateExcelArsip(headers, rows, fileName, title, namaSekolah) {
  let tempId = null;
  try {
    const ss = SpreadsheetApp.create("TEMP_EXPORT");
    tempId = ss.getId();
    const sheet = ss.getSheets()[0];
    
    // Header Judul
    sheet.getRange("A1").setValue(namaSekolah).setFontWeight("bold").setFontSize(12);
    sheet.getRange("A2").setValue(title).setFontWeight("bold").setFontSize(11);
    
    // Header Tabel
    const startRow = 4;
    sheet.getRange(startRow, 1, 1, headers.length).setValues([headers])
         .setFontWeight("bold")
         .setBackground("#d9ead3")
         .setBorder(true, true, true, true, true, true);
    
    // Data Tabel
    // Pastikan semua data dikonversi ke string/number yang aman
    const safeRows = rows.map(r => r.map(c => (c === null || c === undefined) ? "" : c));
    
    sheet.getRange(startRow + 1, 1, safeRows.length, headers.length).setValues(safeRows)
         .setBorder(true, true, true, true, true, true);
    
    sheet.autoResizeColumns(1, headers.length);
    
    SpreadsheetApp.flush();
    
    const url = "https://docs.google.com/spreadsheets/d/" + tempId + "/export?format=xlsx";
    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
    
    return {
      success: true,
      base64: Utilities.base64Encode(response.getBlob().getBytes()),
      fileName: fileName + ".xlsx",
      mimeType: MimeType.MICROSOFT_EXCEL
    };
    
  } catch(e) {
    throw e;
  } finally {
    if (tempId) try { DriveApp.getFileById(tempId).setTrashed(true); } catch(e){}
  }
}

/**
 * [DIPERBARUI] Generate PDF Blob
 * PERBAIKAN: Menambahkan keterangan kode mapel di bawah tabel.
 */
function generatePdfArsip(headers, rows, fileName, title, namaSekolah, mode, legend) {
  
  let tableHeaderHtml = '<tr style="background-color: #f2f2f2;">';
  headers.forEach(h => {
    let align = 'center';
    if (h === 'Nama Siswa') align = 'left';
    tableHeaderHtml += `<th style="border: 1px solid #000; padding: 6px 4px; text-align: ${align}; font-size: 11pt; font-weight: bold;">${h}</th>`;
  });
  tableHeaderHtml += '</tr>';

  let tableBodyHtml = '';
  rows.forEach((row, index) => {
    tableBodyHtml += `<tr>`;
    row.forEach((cell, i) => {
       let style = 'border: 1px solid #000; padding: 5px 4px; font-size: 10.5pt;';
       let val = (cell === null || cell === undefined) ? '' : cell;
       
       const headerName = headers[i];
       if (headerName === 'Nama Siswa') {
          style += ' text-align: left; white-space: nowrap; font-weight: 500;';
       } else if (headerName === 'Tahun Pelajaran' || headerName === 'No' || headerName === 'Kelas' || headerName === 'NISN' || headerName === 'Status') {
          style += ' text-align: center;';
       } else if (headerName === 'Jumlah' || headerName === 'Rata-Rata') {
          style += ' text-align: center; font-weight: bold; background-color: #fdfdfd;';
       } else {
          style += ' text-align: center;';
       }
       tableBodyHtml += `<td style="${style}">${val}</td>`;
    });
    tableBodyHtml += `</tr>`;
  });

  // [PERBAIKAN] Susun HTML Legenda Mapel
  let legendHtml = '';
  if (legend && Object.keys(legend).length > 0) {
      // Filter hanya kode mapel yang ada di tabel saat ini
      const mapelCodes = headers.filter(h => legend[h]);
      
      if (mapelCodes.length > 0) {
        legendHtml = `
          <div style="margin-top: 15px; font-size: 9pt; color: #333; page-break-inside: avoid;">
            <div style="font-weight: bold; margin-bottom: 4px; text-decoration: underline;">Keterangan Kode Mapel:</div>
            <table style="border: none; width: auto;">
        `;
        
        // Susun baris per baris: KODE - NAMA
        mapelCodes.forEach(code => {
           legendHtml += `
             <tr>
               <td style="border: none; padding: 1px 10px 1px 0; font-weight: bold; white-space: nowrap;">${code}</td>
               <td style="border: none; padding: 1px 5px 1px 0;">-</td>
               <td style="border: none; padding: 1px 0;">${legend[code]}</td>
             </tr>
           `;
        });
        
        legendHtml += `</table></div>`;
      }
  }

  const htmlContent = `
    <html>
    <head>
      <style>
        @page { size: A4 landscape; margin: 1cm; } 
        body { font-family: Arial, Helvetica, sans-serif; font-size: 11pt; color: #000; }
        h2 { text-align: center; margin: 0 0 5px 0; text-transform: uppercase; font-size: 18pt; letter-spacing: 1px; }
        h3 { text-align: center; margin: 0 0 20px 0; text-transform: uppercase; font-size: 14pt; font-weight: bold; text-decoration: underline; }
        p.meta { text-align: center; font-size: 10pt; color: #444; margin-bottom: 15px; font-style: italic; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th { background-color: #e0e0e0; }
      </style>
    </head>
    <body>
      <h2>${namaSekolah}</h2>
      <h3>${title}</h3>
      <p class="meta">Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
      
      <table>
        <thead>${tableHeaderHtml}</thead>
        <tbody>${tableBodyHtml}</tbody>
      </table>
      
      ${legendHtml}
      
    </body>
    </html>
  `;

  const blob = Utilities.newBlob(htmlContent, MimeType.HTML).getAs(MimeType.PDF);
  const base64 = Utilities.base64Encode(blob.getBytes());

  return {
      success: true,
      base64: base64,
      fileName: fileName + ".pdf",
      mimeType: MimeType.PDF
  };
}

/**
 * FUNGSI INI HANYA UNTUK MEMICU PERMINTAAN IZIN BARU.
 * 1. Simpan file ini.
 * 2. Pilih fungsi "_triggerUrlFetchPermission" dari dropdown di atas editor.
 * 3. Klik "Run" (Jalankan).
 * 4. Saat diminta, berikan izin (Review Permissions -> Allow).
 * 5. Setelah sukses (atau error "Google"), izin sudah tersimpan.
 */
function _triggerUrlFetchPermission() {
  // Memaksa script meminta izin akses jaringan eksternal
  UrlFetchApp.fetch("https://www.google.com");
}

/**
 * [BARU] Helper untuk mengambil Legenda Mapel (Kode -> Nama Lengkap)
 * Mengambil data dari Database Aplikasi 1 (via Master Sheet).
 */
function getMapelLegend(arsipDbId) {
  try {
    const masterSS = SpreadsheetApp.openById(ID_MASTER_SHEET_APP_1);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    // Cari baris sekolah berdasarkan Arsip DB ID (Kolom V / Index 21)
    const data = sheetSekolah.getDataRange().getValues();
    let app1DbId = null;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][21]) === String(arsipDbId)) { 
        app1DbId = data[i][5]; // Ambil App 1 DB ID (Kolom F / Index 5)
        break;
      }
    }
    
    if (!app1DbId) return {};
    
    // Buka App 1 dan ambil sheet Mapel
    const app1SS = SpreadsheetApp.openById(app1DbId);
    const mapelSheet = app1SS.getSheetByName('Mapel');
    if (!mapelSheet) return {};
    
    const mapelData = mapelSheet.getDataRange().getValues();
    const legend = {};
    
    // Asumsi: Kolom A = Kode, Kolom B = Nama
    for (let i = 1; i < mapelData.length; i++) {
      const code = mapelData[i][0];
      const name = mapelData[i][1];
      if (code && name) {
        legend[code] = name;
      }
    }
    
    return legend;
  } catch (e) {
    Logger.log("Gagal mengambil legenda mapel: " + e.message);
    return {};
  }
}
