<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* FIX SCROLL */
    html { height: auto; min-height: 100%; }
    body { 
        background-color: #f4f6f9; 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh; 
        height: auto;
        overflow-y: visible; 
        overflow-x: hidden;
        touch-action: manipulation; 
    }

    .app-header { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 15px 20px; border-radius: 0 0 15px 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .main-content { max-width: 100%; margin: 0 auto; padding: 15px; display: none; }
    .table-container { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
    .table-responsive { max-height: 70vh; overflow-x: auto; position: relative; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
    
    /* --- KONFIGURASI STICKY TABLE --- */
    
    /* Header Table Selalu Sticky di Atas */
    thead th { background-color: #212529 !important; color: white !important; white-space: nowrap; text-align: center; vertical-align: middle; position: sticky; top: 0; z-index: 10; }
    
    /* --- DEFAULT: MODE SINGLE (Detail Siswa) --- */
    /* Kolom ke-2 (Nama Siswa) yang Sticky */
    tbody td:nth-child(2) { position: sticky; left: 0; z-index: 11; background-color: #fff; border-right: 2px solid #dee2e6; }
    thead th:nth-child(2) { position: sticky; left: 0; z-index: 12; background-color: #212529 !important; border-right: 2px solid #495057; }
    
    /* --- KHUSUS: MODE RANGE (Rentang Tahun) --- */
    /* Reset kolom ke-2 agar TIDAK sticky */
    table.mode-range tbody td:nth-child(2),
    table.mode-range thead th:nth-child(2) {
        position: static !important;
        border-right: 1px solid #dee2e6;
        z-index: auto;
    }

    /* Buat kolom ke-1 (Tahun Pelajaran) menjadi Sticky */
    table.mode-range tbody td:nth-child(1) {
        position: sticky !important;
        left: 0;
        z-index: 11;
        background-color: #fff;
        border-right: 2px solid #dee2e6;
        font-weight: bold;
    }
    table.mode-range thead th:nth-child(1) {
        position: sticky !important;
        left: 0;
        z-index: 12;
        background-color: #212529 !important;
        border-right: 2px solid #495057;
    }
    
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .d-none { display: none !important; }
    
    /* PDF AREA STYLE - DIPERBAIKI */
    #pdf-area { background-color: #e9ecef; padding: 30px; border-radius: 10px; text-align: center; border: 2px dashed #ced4da; margin-top: 20px; }
    
    /* HANYA ubah ikon utama PDF, jangan ikon tombol */
    .pdf-main-icon { font-size: 4rem; color: #dc3545; margin-bottom: 15px; }
    
    /* Pastikan tombol download ukurannya pas */
    #btn-download-pdf { font-weight: 600; font-size: 14px; }
    #btn-download-pdf i { font-size: 14px; color: white; } /* Paksa ikon tombol putih */

    /* --- CSS FOOTER UNIVERSAL (Penyesuaian untuk App 3) --- */
    .universal-footer {
      width: 100%;
      padding: 30px 15px 25px 15px;
      margin-top: auto; /* Dorong ke bawah jika menggunakan flex */
      text-align: center;
      font-size: 13px;
      color: #6c757d;
      background-color: transparent;
      border-top: 1px solid #dee2e6; /* Opsional: Garis pemisah tipis */
    }

    .universal-footer a {
      color: inherit;
      text-decoration: none;
      transition: color 0.2s;
    }

    .universal-footer a:hover {
      color: #0d6efd;
      text-decoration: underline;
    }

    .universal-footer p {
      margin: 0;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loader">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
  <p class="mt-3 text-muted fw-bold" id="loader-text">Memuat Arsip...</p>
</div>

<div class="container" id="view-error" style="display: none; margin-top: 50px; text-align: center;">
    <i class="fas fa-lock text-danger" style="font-size: 60px;"></i>
    <h3 class="mt-3 text-danger">Akses Dibatasi</h3>
    <p class="text-muted">Silakan login melalui Aplikasi Pengolahan Nilai Ijazah.</p>
    <button class="btn btn-primary btn-sm" onclick="logout()">Kembali ke Aplikasi Utama</button>
</div>

<div class="main-content" id="view-dashboard">
  <div class="app-header">
      <h4><i class="fas fa-archive"></i> Arsip Nilai Sekolah</h4>
      <h5 id="dash-nama-sekolah" class="fw-bold mb-0 opacity-75">...</h5>
  </div>

  <div class="d-flex justify-content-end mb-3">
     <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="fas fa-times"></i> Tutup Arsip</button>
  </div>

  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body d-flex align-items-end gap-3 flex-wrap">
      
      <div style="min-width: 180px;">
        <label class="form-label fw-bold small text-primary">Mode Tampilan:</label>
        <select id="select-mode" class="form-select form-select-sm" onchange="handleModeChange()">
          <option value="single">Per Tahun (Detail Siswa)</option>
          <option value="range">Rentang Tahun (Mapel)</option>
          <option value="pdf" style="font-weight: bold; color: #dc3545;">ðŸ“„ Cetak Laporan (PDF)</option>
        </select>
      </div>

      <div id="filter-year-container" class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Pilih Tahun Arsip:</label>
        <select id="select-year" class="form-select form-select-sm" onchange="handleYearChange()">
          <option value="">-- Pilih Tahun --</option>
        </select>
      </div>

      <div id="filter-range-container" class="flex-grow-1 d-none d-flex gap-2" style="min-width: 300px;">
          <div class="flex-grow-1">
            <label class="form-label fw-bold small">Tahun Awal:</label>
            <select id="select-year-start" class="form-select form-select-sm"><option value="">-- Awal --</option></select>
          </div>
          <div class="flex-grow-1">
            <label class="form-label fw-bold small">Tahun Akhir:</label>
            <select id="select-year-end" class="form-select form-select-sm"><option value="">-- Akhir --</option></select>
          </div>
          <button class="btn btn-success btn-sm align-self-end" onclick="loadRangeData()" title="Tampilkan"><i class="fas fa-search"></i></button>
      </div>

      <div id="filter-jenis-container" class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Jenis Nilai:</label>
        <select id="select-jenis" class="form-select form-select-sm" onchange="handleJenisChange()">
          <option value="Ijazah" selected>Nilai Ijazah (Akhir)</option>
          <option value="Ujian">Nilai Ujian (Murni)</option>
          <option value="Rapor">Nilai Rapor (Murni)</option>
        </select>
      </div>

      <div id="filter-search-container" class="flex-grow-1" style="min-width: 200px;">
         <label class="form-label fw-bold small">Cari Siswa:</label>
         <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Nama atau NISN..." onkeyup="filterTableLocal()">
      </div>

      <div id="filter-mapel-container" class="flex-grow-1 d-none" style="min-width: 180px;">
          <label class="form-label fw-bold small text-danger">Mata Pelajaran:</label>
          <select id="select-mapel" class="form-select form-select-sm border-danger">
              <option value="">-- Pilih Mapel Dulu --</option>
          </select>
      </div>

      <div id="filter-kelas-container" class="flex-grow-1 d-none" style="min-width: 120px;">
          <label class="form-label fw-bold small">Kelas:</label>
          <select id="select-kelas" class="form-select form-select-sm">
              <option value="semua">Semua Kelas</option>
          </select>
      </div>
      
      <div id="filter-rows-container" style="min-width: 80px;">
         <label class="form-label fw-bold small">Baris:</label>
         <select id="rows-per-page" class="form-select form-select-sm" onchange="changePageSize()">
             <option value="25" selected>25</option>
             <option value="50">50</option>
             <option value="100">100</option>
             <option value="all">Semua</option>
         </select>
      </div>

    </div>
  </div>

  <div id="table-wrapper" class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="table-title" class="mb-0 text-secondary">Data Arsip</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="data-table">
        <thead id="table-head"></thead>
        <tbody id="table-body"><tr><td class="text-center text-muted p-4">Silakan pilih filter tahun.</td></tr></tbody>
      </table>
    </div>
    <div id="pagination-controls" class="pagination-container" style="display:none;">
        <div class="text-muted small" id="page-info">Menampilkan 0-0 dari 0 data</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><button class="page-link" onclick="prevPage()" id="btn-prev">Sebelumnya</button></li>
                <li class="page-item active"><span class="page-link" id="current-page-label">1</span></li>
                <li class="page-item"><button class="page-link" onclick="nextPage()" id="btn-next">Berikutnya</button></li>
            </ul>
        </nav>
    </div>
  </div>

  <div id="pdf-area" class="d-none">
      <i class="fas fa-file-pdf pdf-main-icon"></i>
      <h4>Cetak Laporan Nilai</h4>
      <p class="text-muted">Silakan pilih <strong>Tahun Arsip</strong> dan <strong>Mata Pelajaran</strong> di atas, lalu klik tombol di bawah.</p>
      <div class="mt-4">
          <button id="btn-download-pdf" class="btn btn-danger px-4 py-2" onclick="downloadPdf()" disabled>
              <i class="fas fa-download me-2"></i> Unduh File PDF
          </button>
      </div>
  </div>

  <footer class="universal-footer mt-4">
    <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer">
      <p>&copy; <span id="footer-year-app3">2025</span> Created by Syamsul Bahri</p>
    </a>
  </footer>

</div> <script>
  document.addEventListener("DOMContentLoaded", function() {
      try {
        const yearSpan = document.getElementById('footer-year-app3');
        if(yearSpan) yearSpan.innerText = new Date().getFullYear();
      } catch(e) {}
  });
</script>

<script>
  // --- GLOBAL VARIABLES ---
  let currentArsipDbId = null;
  let currentNpsn = null;
  let globalTableData = { headers: [], rows: [] }; 
  let filteredRows = []; 
  let currentPage = 1;
  let rowsPerPage = 25;
  
  const URL_APLIKASI_1 = "https://script.google.com/macros/s/AKfycbynRR8fqaFQTVM4QEonhZLMP_Ee_W3DjMHnLBZ8ZuCbRjv_45Mq9iXPfRVL_M-LvNeK/exec"; 

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    google.script.url.getLocation(function(location) {
      const npsn = location.parameter.npsn;
      if (npsn) {
        currentNpsn = npsn;
        otomatisLoginArsip(npsn);
      } else {
        tampilkanError("Parameter NPSN tidak ditemukan. Akses ditolak.");
      }
    });
  });

  // --- LOGIN FLOW ---
  function otomatisLoginArsip(npsn) {
    document.getElementById('loader-text').innerText = "Memverifikasi Arsip Sekolah...";
    google.script.run
      .withSuccessHandler(res => {
        if (res.success) {
          currentArsipDbId = res.data.arsipDbId;
          document.getElementById('dash-nama-sekolah').innerText = res.data.namaSekolah;
          document.getElementById('loader').style.display = 'none';
          document.getElementById('view-dashboard').style.display = 'block';
          loadYears();
        } else {
          tampilkanError(res.message);
        }
      })
      .withFailureHandler(err => tampilkanError("Koneksi Error: " + err.message))
      .loginArsip(npsn);
  }

  function tampilkanError(pesan) {
    document.getElementById('loader').style.display = 'none';
    document.getElementById('view-dashboard').style.display = 'none';
    document.getElementById('view-error').style.display = 'block';
    // Optional: set error message text
  }

  function logout() { window.top.location.href = URL_APLIKASI_1; }
  function showLoader(show, text="Memuat data...") {
     const l = document.getElementById('loader');
     document.getElementById('loader-text').innerText = text;
     l.style.display = show ? 'flex' : 'none';
  }

  // --- DATA LOADING ---
  function loadYears() {
    google.script.run.withSuccessHandler(res => {
      const selects = ['select-year', 'select-year-start', 'select-year-end'];
      selects.forEach(id => {
         const el = document.getElementById(id);
         const def = id === 'select-year' ? '-- Pilih Tahun --' : (id.includes('start')?'-- Awal --':'-- Akhir --');
         el.innerHTML = `<option value="">${def}</option>`;
         if (res.success) {
            res.years.forEach(y => {
              let opt = document.createElement('option');
              opt.value = y;
              opt.innerText = y.replace('Arsip ', '');
              el.appendChild(opt);
            });
         }
      });
    }).getArsipYears(currentArsipDbId);
  }

  // --- EVENT HANDLERS ---
  
  function handleModeChange() {
      const mode = document.getElementById('select-mode').value;
      
      // Elements
      const elSingle = document.getElementById('filter-year-container');
      const elRange = document.getElementById('filter-range-container');
      const elSearch = document.getElementById('filter-search-container');
      const elRows = document.getElementById('filter-rows-container');
      const elMapel = document.getElementById('filter-mapel-container');
      const elKelas = document.getElementById('filter-kelas-container');
      
      const divTable = document.getElementById('table-wrapper');
      const divPdf = document.getElementById('pdf-area');

      // Reset UI
      elSingle.classList.add('d-none');
      elRange.classList.add('d-none');
      elSearch.classList.add('d-none');
      elRows.classList.add('d-none');
      elMapel.classList.add('d-none');
      elKelas.classList.add('d-none');
      divTable.classList.add('d-none');
      divPdf.classList.add('d-none');
      
      // Reset Inputs
      document.getElementById('select-year').value = "";
      document.getElementById('select-mapel').innerHTML = '<option value="">-- Pilih Mapel Dulu --</option>';
      document.getElementById('select-kelas').innerHTML = '<option value="semua">Semua Kelas</option>';

      if (mode === 'single') {
          elSingle.classList.remove('d-none');
          elSearch.classList.remove('d-none');
          elRows.classList.remove('d-none');
          divTable.classList.remove('d-none');
          document.getElementById('table-title').innerText = "Data Arsip";
          clearTable();
      } 
      else if (mode === 'range') {
          elRange.classList.remove('d-none');
          divTable.classList.remove('d-none');
          document.getElementById('table-title').innerText = "Rekapitulasi Rentang Tahun";
          clearTable();
      } 
      else if (mode === 'pdf') {
          elSingle.classList.remove('d-none'); // Butuh pilih tahun
          elMapel.classList.remove('d-none');  // Butuh pilih mapel
          elKelas.classList.remove('d-none');  // Butuh pilih kelas
          divPdf.classList.remove('d-none');   // Tampilkan area PDF
          document.getElementById('btn-download-pdf').disabled = true;
      }
  }

  function handleYearChange() {
      const mode = document.getElementById('select-mode').value;
      const sheetName = document.getElementById('select-year').value;
      
      if (!sheetName) return;

      if (mode === 'single') {
          // Mode Single: Load Data Tabel
          loadTableData(sheetName);
      } else if (mode === 'pdf') {
          // Mode PDF: Load Mapel & Kelas untuk dropdown
          loadDropdownsForPdf(sheetName);
      }
  }
  
  function handleJenisChange() {
      const mode = document.getElementById('select-mode').value;
      if (mode === 'single') {
          if (globalTableData.rows.length > 0) renderTable(); // Re-render dari cache
      } else if (mode === 'range') {
          loadRangeData(); // Reload server
      }
  }

  // --- LOGIKA MODE TABEL (SINGLE) ---
  function loadTableData(sheetName) {
      showLoader(true, "Mengambil data arsip...");
      document.getElementById('table-title').innerText = "Data Arsip: " + sheetName.replace('Arsip ', '');
      
      google.script.run.withSuccessHandler(res => {
          showLoader(false);
          if(res.success) {
              globalTableData.headers = res.headers;
              globalTableData.rows = res.rows;
              filteredRows = res.rows;
              currentPage = 1;
              renderTable();
          } else {
              alert("Gagal: " + res.message);
          }
      }).getArsipData(currentArsipDbId, sheetName);
  }
  
  // --- LOGIKA MODE RANGE ---
  function loadRangeData() {
      const start = document.getElementById('select-year-start').value;
      const end = document.getElementById('select-year-end').value;
      const jenis = document.getElementById('select-jenis').value;
      
      if(!start || !end) return;
      
      showLoader(true, "Menganalisis rentang tahun...");
      google.script.run.withSuccessHandler(res => {
          showLoader(false);
          if(res.success) {
              globalTableData.headers = res.headers;
              globalTableData.rows = res.rows;
              filteredRows = res.rows; // No client filtering for range yet
              renderTableRange();
          } else {
              alert("Gagal: " + res.message);
          }
      }).getArsipDataRange(currentArsipDbId, start, end, jenis);
  }

  // --- LOGIKA MODE PDF ---
  function loadDropdownsForPdf(sheetName) {
      // 1. Load Mapel
      const elMapel = document.getElementById('select-mapel');
      const elKelas = document.getElementById('select-kelas');
      const btnPdf = document.getElementById('btn-download-pdf');
      
      elMapel.innerHTML = '<option>Memuat...</option>';
      elMapel.disabled = true;
      elKelas.innerHTML = '<option>Memuat...</option>';
      elKelas.disabled = true;
      btnPdf.disabled = true;

      // Panggil Mapel
      google.script.run.withSuccessHandler(res => {
          elMapel.innerHTML = '<option value="">-- Pilih Mapel --</option>';
          elMapel.disabled = false;
          if(res.success) {
              res.mapels.forEach(m => {
                  let opt = document.createElement('option');
                  opt.value = m; opt.innerText = m;
                  elMapel.appendChild(opt);
              });
          }
          checkPdfReady();
      }).getMapelListFromArsip(currentArsipDbId, sheetName);

      // Panggil Kelas
      google.script.run.withSuccessHandler(res => {
          elKelas.innerHTML = '<option value="semua">Semua Kelas</option>';
          elKelas.disabled = false;
          if(res.success && res.classes.length > 0) {
              res.classes.forEach(c => {
                  let opt = document.createElement('option');
                  opt.value = c; opt.innerText = c;
                  elKelas.appendChild(opt);
              });
          }
          checkPdfReady();
      }).getClassListFromArsip(currentArsipDbId, sheetName);
  }
  
  // Listener perubahan Mapel untuk aktifkan tombol
  document.getElementById('select-mapel').addEventListener('change', checkPdfReady);
  
  function checkPdfReady() {
      const mapel = document.getElementById('select-mapel').value;
      const btn = document.getElementById('btn-download-pdf');
      btn.disabled = !mapel; // Aktif jika mapel dipilih
  }

  function downloadPdf() {
      const sheetName = document.getElementById('select-year').value;
      const mapel = document.getElementById('select-mapel').value;
      const jenis = document.getElementById('select-jenis').value;
      const kelas = document.getElementById('select-kelas').value;
      
      if(!sheetName || !mapel) { alert("Lengkapi filter."); return; }
      
      showLoader(true, "Membuat PDF Laporan...");
      
      google.script.run
        .withSuccessHandler(res => {
            showLoader(false);
            if(res.success) {
                const link = document.createElement('a');
                link.href = `data:application/pdf;base64,${res.base64Data}`;
                link.download = res.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Gagal: " + res.message);
            }
        })
        .withFailureHandler(err => { showLoader(false); alert("Error: "+err.message); })
        // Gunakan currentNpsn dari URL
        .generateArsipPdf(currentNpsn, sheetName, mapel, jenis, kelas);
  }

  // --- TABLE RENDERING UTILS ---
  function clearTable() {
      document.getElementById('table-head').innerHTML = '';
      document.getElementById('table-body').innerHTML = '<tr><td colspan="100%" class="text-center p-4 text-muted">Silakan pilih filter tahun.</td></tr>';
      document.getElementById('pagination-controls').style.display = 'none';
  }

  function renderTable() {
      // --- TAMBAHAN: Reset mode agar Sticky kembali ke Kolom 2 (Nama Siswa) ---
      const tableElement = document.getElementById('data-table');
      if (tableElement) {
          tableElement.classList.remove('mode-range'); 
      }
      // -----------------------------------------------------------------------

      // Logika render untuk mode Single
      const jenis = document.getElementById('select-jenis').value;
      const headers = globalTableData.headers;
      const thead = document.getElementById('table-head');
      const tbody = document.getElementById('table-body');
      
      thead.innerHTML = ''; tbody.innerHTML = '';
      
      // Cari index kolom dinamis
      const idxMapel = [];
      let idxJml = -1, idxRata = -1, idxStatus = -1;
      
      headers.forEach((h, i) => {
         if(h === `Jumlah_${jenis}`) idxJml = i;
         else if(h === `Rata_${jenis}`) idxRata = i;
         else if(h === 'Status') idxStatus = i;
         else if(h.endsWith(`_${jenis}`)) idxMapel.push(i);
      });
      
      // Build Header
      let hHtml = `<tr><th width="30">No</th><th width="200">Nama Siswa</th><th width="100">NISN</th><th width="60">Kelas</th>`;
      idxMapel.forEach(i => hHtml += `<th>${headers[i].replace('_'+jenis,'')}</th>`);
      hHtml += `<th class="bg-primary text-white">Jumlah</th><th class="bg-primary text-white">Rata-Rata</th><th>Status</th></tr>`;
      thead.innerHTML = hHtml;
      
      // Pagination Slice
      const total = filteredRows.length;
      let start = 0, end = total;
      if(rowsPerPage !== 'all') {
         const rp = parseInt(rowsPerPage);
         start = (currentPage - 1) * rp;
         end = Math.min(start + rp, total);
      }
      
      const viewRows = filteredRows.slice(start, end);
      
      if(viewRows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="100%" class="text-center">Data tidak ditemukan.</td></tr>';
      } else {
          viewRows.forEach((row, i) => {
              let tr = `<tr>
                <td>${start + i + 1}</td>
                <td>${row[1]}</td> <td>${row[2]}</td> <td class="text-center">${row[3]}</td> `;
              
              let hitungSum = 0;
              let hitungCount = 0;

              // Nilai Mapel & Akumulasi
              idxMapel.forEach(idx => {
                  const val = row[idx];
                  tr += `<td class="text-center">${val||''}</td>`;
                  
                  // Logika hitung manual
                  if (val !== "" && val !== null && !isNaN(parseFloat(val))) {
                      hitungSum += parseFloat(val);
                      hitungCount++;
                  }
              });
              
              // Tentukan Nilai Akhir
              const displayJml = (idxJml > -1 && row[idxJml] !== "") 
                  ? row[idxJml] 
                  : (hitungCount > 0 ? parseFloat(hitungSum.toFixed(2)) : 0);

              const displayRata = (idxRata > -1 && row[idxRata] !== "") 
                  ? row[idxRata] 
                  : (hitungCount > 0 ? (hitungSum / hitungCount).toFixed(2) : 0);
              
              // Totals (Tampilkan Hasil)
              tr += `<td class="text-center fw-bold">${displayJml}</td>`;
              tr += `<td class="text-center fw-bold">${displayRata}</td>`;
              
              // Status
              const stat = idxStatus > -1 ? row[idxStatus] : '';
              let badge = stat==='LULUS'?'bg-success':(stat==='TIDAK LULUS'?'bg-danger':'bg-secondary');
              tr += `<td class="text-center"><span class="badge ${badge}">${stat}</span></td></tr>`;
              
              tbody.innerHTML += tr;
          });
      }
      updatePaginationInfo(total, start, end);
  }
  
  function renderTableRange() {
      // --- TAMBAHAN: Aktifkan mode range (Sticky pindah ke Kolom 1 / Tahun) ---
      const tableElement = document.getElementById('data-table');
      if (tableElement) {
          tableElement.classList.add('mode-range');
      }
      // -----------------------------------------------------------------------

      // Render sederhana untuk mode Range
      const headers = globalTableData.headers;
      const rows = globalTableData.rows;
      const thead = document.getElementById('table-head');
      const tbody = document.getElementById('table-body');
      
      thead.innerHTML = ''; tbody.innerHTML = '';
      document.getElementById('pagination-controls').style.display = 'none';
      
      let hHtml = '<tr>';
      headers.forEach(h => {
         let style = (h==='Jumlah'||h==='Rata-Rata') ? 'class="bg-primary text-white"' : '';
         hHtml += `<th ${style}>${h}</th>`;
      });
      hHtml += '</tr>';
      thead.innerHTML = hHtml;
      
      rows.forEach(row => {
          let rHtml = '<tr>';
          row.forEach((cell, i) => {
              let style = (headers[i]==='Jumlah'||headers[i]==='Rata-Rata') ? 'fw-bold text-center' : (i>0 ? 'text-center' : '');
              rHtml += `<td class="${style}">${cell}</td>`;
          });
          rHtml += '</tr>';
          tbody.innerHTML += rHtml;
      });
  }

  function filterTableLocal() {
      const q = document.getElementById('search-input').value.toLowerCase();
      filteredRows = globalTableData.rows.filter(r => {
          // r[1] = Nama, r[2] = NISN (Asumsi struktur array konsisten dari getArsipData)
          const nama = String(r[1]).toLowerCase();
          const nisn = String(r[2]).toLowerCase();
          return nama.includes(q) || nisn.includes(q);
      });
      currentPage = 1;
      renderTable();
  }

  function changePageSize() { rowsPerPage = document.getElementById('rows-per-page').value; currentPage=1; renderTable(); }
  function nextPage() { if(rowsPerPage==='all')return; currentPage++; renderTable(); }
  function prevPage() { if(currentPage>1) { currentPage--; renderTable(); } }
  
  function updatePaginationInfo(total, start, end) {
      const div = document.getElementById('pagination-controls');
      if(total===0 || document.getElementById('select-mode').value !== 'single') { div.style.display='none'; return; }
      div.style.display = 'flex';
      
      document.getElementById('page-info').innerText = `Menampilkan ${start+1}-${end} dari ${total} data`;
      document.getElementById('current-page-label').innerText = currentPage;
      
      const maxPage = Math.ceil(total/parseInt(rowsPerPage));
      document.getElementById('btn-prev').parentElement.classList.toggle('disabled', currentPage===1);
      document.getElementById('btn-next').parentElement.classList.toggle('disabled', currentPage>=maxPage);
  }
</script>

</body>
</html>
