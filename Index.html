<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .card-login { max-width: 400px; margin: 50px auto; border-radius: 15px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .app-header { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center; }
    .main-content { max-width: 100%; margin: 20px auto; padding: 15px; display: none; }
    
    /* CONTAINER TABEL RESPONSIVE */
    .table-container { 
        background: white; 
        border-radius: 10px; 
        padding: 15px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        overflow: hidden; /* Wrapper utama */
    }

    .table-responsive {
        max-height: 70vh; /* Scroll Vertikal */
        overflow-x: auto; /* Scroll Horizontal */
        position: relative;
    }

    /* TABLE HEADER STICKY */
    thead th { 
      background-color: #212529 !important; 
      color: white !important; 
      white-space: nowrap; /* Header jangan wrap */
      text-align: center;
      vertical-align: middle;
      position: sticky; 
      top: 0;
      z-index: 10;
      border-top: none !important;
    }

    /* TABLE BODY */
    tbody td {
      white-space: nowrap; /* KUNCI: Nama tidak akan turun baris */
      vertical-align: middle;
      padding: 8px 10px;
    }
    
    /* NAMA SISWA (Kolom 2) STICKY DI KIRI (Opsional, biar enak dilihat di HP) */
    /* Hapus blok ini jika tidak ingin nama sticky */
    tbody td:nth-child(2), thead th:nth-child(2) {
        position: sticky;
        left: 0;
        z-index: 11; /* Di atas data lain */
        background-color: inherit; /* Ikuti warna baris */
    }
    thead th:nth-child(2) { z-index: 12; background-color: #212529 !important; } /* Header nama */

    /* UKURAN KOLOM MAPEL & NILAI SERAGAM */
    /* Target kolom ke-5 dst (Nilai Mapel) */
    th:nth-child(n+5), td:nth-child(n+5) {
       min-width: 60px;
       max-width: 60px;
       text-align: center;
    }
    
    /* Highlight Baris saat Hover */
    tbody tr:hover td {
        background-color: #e2e6ea !important; /* Warna hover */
    }

    /* Pagination Controls */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
    }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<div class="loading-overlay" id="loader">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>

<div class="container" id="view-login">
  <div class="card card-login">
    <div class="app-header">
      <h4><i class="fas fa-archive"></i> Arsip Nilai</h4>
      <p class="mb-0">Masuk dengan NPSN Sekolah</p>
    </div>
    <div class="card-body p-4">
      <form onsubmit="handleLogin(event)">
        <div class="mb-3">
          <label class="form-label">NPSN Sekolah</label>
          <input type="text" id="input-npsn" class="form-control form-control-lg text-center" placeholder="Contoh: 12345678" required>
        </div>
        <button type="submit" class="btn btn-primary w-100 btn-lg">Buka Arsip</button>
      </form>
      <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
    </div>
  </div>
</div>

<div class="main-content" id="view-dashboard">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 id="dash-nama-sekolah" class="text-primary fw-bold">Nama Sekolah</h3>
      <p class="text-muted mb-0">Arsip Rekapitulasi Nilai Tahunan</p>
    </div>
    <button class="btn btn-outline-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Keluar</button>
  </div>

  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body d-flex align-items-end gap-3 flex-wrap">
      
      <div class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Pilih Tahun Arsip:</label>
        <select id="select-year" class="form-select form-select-sm" onchange="loadTableData()">
          <option value="">-- Pilih Tahun --</option>
        </select>
      </div>

      <div class="flex-grow-1" style="min-width: 150px;">
        <label class="form-label fw-bold small">Jenis Nilai:</label>
        <select id="select-jenis" class="form-select form-select-sm" onchange="renderTableFromCache()">
          <option value="Ijazah" selected>Nilai Ijazah (Akhir)</option>
          <option value="Ujian">Nilai Ujian (Murni)</option>
          <option value="Rapor">Nilai Rapor (Murni)</option>
        </select>
      </div>

      <div class="flex-grow-1" style="min-width: 200px;">
         <label class="form-label fw-bold small">Cari Siswa:</label>
         <input type="text" id="search-input" class="form-control form-control-sm" placeholder="Nama atau NISN..." onkeyup="handleSearch()">
      </div>
      
      <div style="min-width: 100px;">
         <label class="form-label fw-bold small">Tampilkan:</label>
         <select id="rows-per-page" class="form-select form-select-sm" onchange="changePageSize()">
             <option value="25" selected>25</option>
             <option value="50">50</option>
             <option value="100">100</option>
             <option value="all">Semua</option>
         </select>
      </div>

    </div>
  </div>

  <div class="table-container">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="table-title" class="mb-0 text-secondary">Data Arsip</h5>
    </div>
    
    <div class="table-responsive">
      <table class="table table-bordered table-sm" id="data-table">
        <thead id="table-head"></thead>
        <tbody id="table-body">
            <tr><td class="text-center text-muted p-4">Silakan pilih tahun arsip untuk melihat data.</td></tr>
        </tbody>
      </table>
    </div>

    <div id="pagination-controls" class="pagination-container" style="display:none;">
        <div class="text-muted small" id="page-info">Menampilkan 0-0 dari 0 data</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item"><button class="page-link" onclick="prevPage()" id="btn-prev">Sebelumnya</button></li>
                <li class="page-item active"><span class="page-link" id="current-page-label">1</span></li>
                <li class="page-item"><button class="page-link" onclick="nextPage()" id="btn-next">Berikutnya</button></li>
            </ul>
        </nav>
    </div>
  </div>
</div>

<script>
  let currentArsipDbId = null;
  // Variabel Global Data
  let globalTableData = { headers: [], rows: [] }; 
  let filteredRows = []; // Data hasil search
  
  // Variabel Paginasi
  let currentPage = 1;
  let rowsPerPage = 25;

  function showLoader(show) {
    document.getElementById('loader').style.display = show ? 'flex' : 'none';
  }

  function handleLogin(e) {
    e.preventDefault();
    const npsn = document.getElementById('input-npsn').value;
    showLoader(true);
    document.getElementById('login-error').classList.add('d-none');
    
    google.script.run
      .withSuccessHandler(res => {
        showLoader(false);
        if (res.success) {
          currentArsipDbId = res.data.arsipDbId;
          document.getElementById('dash-nama-sekolah').innerText = res.data.namaSekolah;
          document.getElementById('view-login').style.display = 'none';
          document.getElementById('view-dashboard').style.display = 'block';
          loadYears();
        } else {
          const err = document.getElementById('login-error');
          err.innerText = res.message;
          err.classList.remove('d-none');
        }
      })
      .withFailureHandler(err => {
        showLoader(false);
        alert("Error: " + err.message);
      })
      .loginArsip(npsn);
  }

  function loadYears() {
    google.script.run.withSuccessHandler(res => {
      const select = document.getElementById('select-year');
      select.innerHTML = '<option value="">-- Pilih Tahun --</option>';
      if (res.success && res.years.length > 0) {
        res.years.forEach(year => {
          const opt = document.createElement('option');
          opt.value = year;
          opt.innerText = year.replace('Arsip ', '');
          select.appendChild(opt);
        });
      }
    }).getArsipYears(currentArsipDbId);
  }

  function loadTableData() {
    const sheetName = document.getElementById('select-year').value;
    if (!sheetName) return;
    
    showLoader(true);
    document.getElementById('table-title').innerText = "Data Arsip: " + sheetName.replace('Arsip ', '');
    
    google.script.run.withSuccessHandler(res => {
      showLoader(false);
      if (res.success) {
        globalTableData.headers = res.headers;
        globalTableData.rows = res.rows;
        filteredRows = res.rows; // Awalnya semua data
        
        currentPage = 1; // Reset ke halaman 1
        renderTableFromCache(); 
      } else {
        alert("Gagal memuat data: " + res.message);
      }
    }).getArsipData(currentArsipDbId, sheetName);
  }

  // --- FUNGSI RENDER TABEL UTAMA ---
  function renderTableFromCache() {
    const jenis = document.getElementById('select-jenis').value; 
    const rawHeaders = globalTableData.headers;
    
    const thead = document.getElementById('table-head');
    const tbody = document.getElementById('table-body');
    const paginationDiv = document.getElementById('pagination-controls');
    
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (filteredRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">Data kosong.</td></tr>';
        paginationDiv.style.display = 'none';
        return;
    }

    // 1. LOGIKA FILTER KOLOM (Perbaikan: Hindari Duplikasi)
    const indicesMapel = [];
    let indexJumlah = -1;
    let indexRata = -1;
    const statusIndex = rawHeaders.length - 1;
    
    // Loop header (mulai index 4 untuk skip No, Nama, NISN, Kelas)
    for (let i = 4; i < rawHeaders.length - 1; i++) { 
        const h = rawHeaders[i];
        
        if (h === 'Jumlah_' + jenis) {
            indexJumlah = i; // Simpan index Jumlah
        } else if (h === 'Rata_' + jenis) {
            indexRata = i;   // Simpan index Rata
        } else if (h.endsWith('_' + jenis)) {
            // Pastikan bukan kolom Jumlah/Rata yg kebetulan berakhiran sama
            if (!h.startsWith('Jumlah_') && !h.startsWith('Rata_')) {
                indicesMapel.push(i);
            }
        }
    }
    
    // Susun ulang: [Info Siswa] + [Mapel] + [Jumlah] + [Rata] + [Status]
    const indicesToShow = [0, 1, 2, 3, ...indicesMapel];
    if (indexJumlah !== -1) indicesToShow.push(indexJumlah);
    if (indexRata !== -1) indicesToShow.push(indexRata);
    indicesToShow.push(statusIndex);

    // 2. RENDER HEADER
    let headerHtml = '<tr>';
    indicesToShow.forEach(idx => {
        let rawH = rawHeaders[idx];
        // Bersihkan nama header
        let displayH = rawH
            .replace('_' + jenis, '')
            .replace('Jumlah_' + jenis, 'Jumlah')
            .replace('Rata_' + jenis, 'Rata-Rata');
        
        // Highlight kolom spesial
        let style = '';
        if (displayH === 'Jumlah' || displayH === 'Rata-Rata' || displayH === 'Status') {
            style = 'style="background-color: #0d6efd !important;"'; // Biru
        }
        headerHtml += `<th ${style}>${displayH}</th>`;
    });
    headerHtml += '</tr>';
    thead.innerHTML = headerHtml;

    // 3. LOGIKA PAGINASI
    const totalRows = filteredRows.length;
    let startIdx = 0;
    let endIdx = totalRows;

    if (rowsPerPage !== 'all') {
        const pageSize = parseInt(rowsPerPage);
        startIdx = (currentPage - 1) * pageSize;
        endIdx = Math.min(startIdx + pageSize, totalRows);
    }

    const rowsToRender = filteredRows.slice(startIdx, endIdx);

    // 4. RENDER BODY
    rowsToRender.forEach(row => {
        let rowHtml = '<tr>';
        indicesToShow.forEach(idx => {
            let cellVal = row[idx] || '';
            // Badge Status
            if (idx === statusIndex) {
                let badgeClass = cellVal === 'LULUS' ? 'bg-success' : 'bg-danger';
                cellVal = `<span class="badge ${badgeClass}">${cellVal}</span>`;
            }
            rowHtml += `<td>${cellVal}</td>`;
        });
        rowHtml += '</tr>';
        tbody.innerHTML += rowHtml;
    });
    
    updatePaginationInfo(totalRows, startIdx, endIdx);
  }

  // --- FUNGSI SEARCH ---
  function handleSearch() {
    const input = document.getElementById('search-input').value.toLowerCase();
    
    if (input.length < 1) {
        filteredRows = globalTableData.rows;
    } else {
        filteredRows = globalTableData.rows.filter(row => {
            const nama = (row[1] || '').toString().toLowerCase();
            const nisn = (row[2] || '').toString().toLowerCase();
            return nama.includes(input) || nisn.includes(input);
        });
    }
    currentPage = 1; // Reset ke halaman 1
    renderTableFromCache();
  }

  // --- FUNGSI PAGINASI ---
  function changePageSize() {
    rowsPerPage = document.getElementById('rows-per-page').value;
    currentPage = 1;
    renderTableFromCache();
  }

  function nextPage() {
    if (rowsPerPage === 'all') return;
    const maxPage = Math.ceil(filteredRows.length / parseInt(rowsPerPage));
    if (currentPage < maxPage) {
        currentPage++;
        renderTableFromCache();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderTableFromCache();
    }
  }

  function updatePaginationInfo(total, start, end) {
    const paginationDiv = document.getElementById('pagination-controls');
    const pageInfo = document.getElementById('page-info');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageLabel = document.getElementById('current-page-label');

    if (total === 0) {
        paginationDiv.style.display = 'none';
        return;
    }
    paginationDiv.style.display = 'flex';

    if (rowsPerPage === 'all') {
        pageInfo.innerText = `Menampilkan semua ${total} data`;
        btnPrev.parentElement.classList.add('disabled');
        btnNext.parentElement.classList.add('disabled');
        pageLabel.innerText = '1';
    } else {
        pageInfo.innerText = `Menampilkan ${start + 1}-${end} dari ${total} data`;
        
        const maxPage = Math.ceil(total / parseInt(rowsPerPage));
        pageLabel.innerText = `${currentPage} / ${maxPage}`;

        if (currentPage === 1) btnPrev.parentElement.classList.add('disabled');
        else btnPrev.parentElement.classList.remove('disabled');

        if (currentPage === maxPage) btnNext.parentElement.classList.add('disabled');
        else btnNext.parentElement.classList.remove('disabled');
    }
  }

  function logout() {
    location.reload();
  }
</script>

</body>
</html>
