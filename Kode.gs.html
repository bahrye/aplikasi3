const ID_MASTER_SHEET_APP_1 = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 

// --- FUNGSI PEMICU IZIN (JANGAN DIHAPUS) ---
function _triggerDrivePermission() {
  DriveApp.getFiles();
}

function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Arsip Nilai Sekolah')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .setFaviconUrl("https://images.icon-icons.com/1147/PNG/512/1486486315-archive-archives-files-hosting-database-server-storage_81222.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

function loginArsip(npsn) {
  try {
    if (!npsn) throw new Error("NPSN wajib diisi.");
    
    // CACHE LOGIN: Cek apakah info sekolah untuk NPSN ini ada di cache
    const cache = CacheService.getScriptCache();
    const cacheKey = "LOGIN_ARSIP_" + npsn;
    const cachedData = cache.get(cacheKey);
    
    if (cachedData) {
       return { success: true, data: JSON.parse(cachedData) };
    }

    const masterSS = SpreadsheetApp.openById(ID_MASTER_SHEET_APP_1);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();
    
    let sekolahInfo = null;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][7]).trim() === String(npsn).trim()) { // Kolom H = NPSN
        sekolahInfo = {
          namaSekolah: data[i][1],
          arsipDbId: data[i][21] // Kolom V = Arsip_DB_ID
        };
        break;
      }
    }
    
    if (!sekolahInfo) throw new Error("NPSN tidak ditemukan.");
    if (!sekolahInfo.arsipDbId) throw new Error("Sekolah ini belum memiliki Arsip Nilai.");
    
    // Simpan hasil login ke cache selama 6 jam
    cache.put(cacheKey, JSON.stringify(sekolahInfo), 21600);

    return { success: true, data: sekolahInfo };
    
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipYears(arsipDbId) {
  try {
    // CACHE YEARS: Daftar tahun jarang berubah
    const cache = CacheService.getScriptCache();
    const cacheKey = "YEARS_" + arsipDbId;
    const cachedData = cache.get(cacheKey);
    
    if (cachedData) {
       return { success: true, years: JSON.parse(cachedData) };
    }

    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheets = ss.getSheets();
    const years = [];
    
    sheets.forEach(sheet => {
      const name = sheet.getName();
      if (name.startsWith("Arsip ")) {
        years.push(name);
      }
    });
    years.sort().reverse();
    
    // Simpan ke cache 6 jam
    cache.put(cacheKey, JSON.stringify(years), 21600);
    
    return { success: true, years: years };
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipData(arsipDbId, sheetName) {
  try {
    // CACHE DATA: Ini yang paling penting untuk mencegah Error 429
    const cache = CacheService.getScriptCache();
    const cacheKey = "DATA_" + arsipDbId + "_" + sheetName;
    const cachedData = cache.get(cacheKey);

    if (cachedData) {
      return JSON.parse(cachedData); // Return langsung tanpa buka Spreadsheet
    }

    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error("Data tahun tersebut tidak ditemukan.");
    
    const data = sheet.getDataRange().getDisplayValues();
    const headers = data.shift();
    
    const result = { success: true, headers: headers, rows: data };

    // Simpan ke cache. Gunakan try-catch karena limit cache per item adalah 100KB.
    try {
      cache.put(cacheKey, JSON.stringify(result), 21600);
    } catch (err) {
      Logger.log("Data terlalu besar untuk cache: " + err.message);
    }

    return result;
  } catch (e) {
    return { success: false, message: e.message };
  }
}

function getArsipDataRange(arsipDbId, startSheet, endSheet, jenisNilai) {
  // Fungsi Range ini kompleks, kita cache hasil akhirnya
  const cache = CacheService.getScriptCache();
  const cacheKey = "RANGE_" + arsipDbId + "_" + startSheet + "_" + endSheet + "_" + jenisNilai;
  const cachedData = cache.get(cacheKey);

  if (cachedData) {
     return JSON.parse(cachedData);
  }

  try {
    const ss = SpreadsheetApp.openById(arsipDbId);
    const allSheets = ss.getSheets();
    const arsipSheets = [];
    
    allSheets.forEach(s => {
      const name = s.getName();
      if (name.startsWith("Arsip ")) arsipSheets.push(name);
    });
    arsipSheets.sort();
    
    const startIndex = arsipSheets.indexOf(startSheet);
    const endIndex = arsipSheets.indexOf(endSheet);
    
    if (startIndex === -1 || endIndex === -1) throw new Error("Tahun awal atau akhir tidak valid.");
    
    const start = Math.min(startIndex, endIndex);
    const end = Math.max(startIndex, endIndex);
    const targetSheets = arsipSheets.slice(start, end + 1);
    
    const suffix = "_" + jenisNilai;
    const rowsResult = [];
    const allMapels = new Set();
    
    targetSheets.forEach(sheetName => {
       const sheet = ss.getSheetByName(sheetName);
       const data = sheet.getDataRange().getValues();
       if (data.length <= 1) return;

       const headers = data.shift();
       const mapelIndices = {}; 
       headers.forEach((h, i) => {
         if (h.endsWith(suffix)) {
           const mapel = h.replace(suffix, '');
           if (mapel !== 'Jumlah' && mapel !== 'Rata') {
             mapelIndices[mapel] = i;
             allMapels.add(mapel);
           }
         }
       });
       
       const sums = {};
       const counts = {};
       let studentCount = 0;
       
       data.forEach(row => {
         studentCount++;
         for (const [m, idx] of Object.entries(mapelIndices)) {
            const val = row[idx];
            if (val !== "" && val !== null && !isNaN(val)) {
               sums[m] = (sums[m] || 0) + Number(val);
               counts[m] = (counts[m] || 0) + 1;
            }
         }
       });
       
       const rowData = {
         'Tahun Pelajaran': sheetName.replace('Arsip ', ''),
         '_meta_student_count': studentCount
       };
       
       let totalAvgSum = 0;
       let mapelCount = 0;
       
       for (const [m, sum] of Object.entries(sums)) {
          const count = counts[m] || 0;
          if (count > 0) {
             const avg = sum / count;
             rowData[m] = avg;
             totalAvgSum += avg;
             mapelCount++;
          }
       }
       
       rowData['Jumlah'] = totalAvgSum;
       rowData['Rata-Rata'] = mapelCount > 0 ? (totalAvgSum / mapelCount) : 0;
       rowsResult.push(rowData);
    });
    
    const sortedMapels = Array.from(allMapels).sort();
    const finalHeaders = ['Tahun Pelajaran', ...sortedMapels, 'Jumlah', 'Rata-Rata'];
    
    const finalRows = rowsResult.map(r => {
       return finalHeaders.map(h => {
          const val = r[h];
          if (typeof val === 'number') return val.toFixed(2);
          return val || '';
       });
    });
    
    const result = { success: true, headers: finalHeaders, rows: finalRows };
    
    // Cache hasil kalkulasi
    try { cache.put(cacheKey, JSON.stringify(result), 21600); } catch(e){}

    return result;
    
  } catch (e) {
    return { success: false, message: e.message };
  }
}

// --- OPTIMASI UNTUK MENCEGAH ERROR 429 (DROPDOWN PDF) ---
function getArsipDropdownData(arsipDbId, sheetName) {
  // CACHE DROPDOWN
  const cache = CacheService.getScriptCache();
  const cacheKey = "DROPDOWN_" + arsipDbId + "_" + sheetName;
  const cachedData = cache.get(cacheKey);

  if (cachedData) {
    return JSON.parse(cachedData);
  }

  try {
    const ss = SpreadsheetApp.openById(arsipDbId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) throw new Error("Data tahun tersebut tidak ditemukan.");
    
    const data = sheet.getDataRange().getValues();
    if (data.length === 0) return { success: true, mapels: [], classes: [] };
    
    const headers = data[0];
    
    // 1. Proses Mapel
    const mapelSet = new Set();
    const ignoreHeaders = [
      'No', 'Nama Siswa', 'NISN', 'Kelas', 'Status', 
      'Jumlah_Ujian', 'Jumlah_Rapor', 'Jumlah_Ijazah', 
      'Rata_Ujian', 'Rata_Rapor', 'Rata_Ijazah'
    ];
    
    headers.forEach(h => {
      if (h && !ignoreHeaders.includes(h)) {
        const lastUnderscore = h.lastIndexOf('_');
        if (lastUnderscore > 0) {
          const mapelName = h.substring(0, lastUnderscore);
          if (mapelName.length > 1) {
            mapelSet.add(mapelName);
          }
        }
      }
    });

    // 2. Proses Kelas
    const idxKelas = headers.indexOf('Kelas');
    const classSet = new Set();
    
    if (idxKelas !== -1 && data.length > 1) {
      for (let i = 1; i < data.length; i++) {
        const k = data[i][idxKelas];
        if (k) classSet.add(k);
      }
    }
    
    const result = { 
      success: true, 
      mapels: Array.from(mapelSet).sort(), 
      classes: Array.from(classSet).sort() 
    };

    // Simpan Cache
    cache.put(cacheKey, JSON.stringify(result), 21600);

    return result;

  } catch (e) {
    return { success: false, message: e.message };
  }
}

// --- GENERATE PDF (CACHE TIDAK DIPERLUKAN KARENA PDF SELALU UNIK/JARANG) ---
function generateArsipPdf(npsn, sheetName, mapel, jenisNilai, filterKelas) {
  // LockService penting untuk PDF agar tidak tabrakan
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(30000); 

    // --- AMBIL CACHE ID SEKOLAH JIKA ADA (OPTIMASI KECIL) ---
    // Kita masih perlu buka SS untuk ambil data nilai, tapi kita bisa skip pencarian NPSN
    
    const masterSS = SpreadsheetApp.openById(ID_MASTER_SHEET_APP_1);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataMaster = sheetSekolah.getDataRange().getValues();
    let rowData = null;
    
    for(let i=1; i<dataMaster.length; i++) {
      if (String(dataMaster[i][7]).trim() === String(npsn).trim()) {
        rowData = dataMaster[i];
        break;
      }
    }
    
    if (!rowData) throw new Error("Data sekolah tidak ditemukan (NPSN tidak cocok).");

    const namaSekolah = rowData[1]; 
    const app1DbId = rowData[5];    
    const kopFileId = rowData[15];  
    const tempatTtd = rowData[19] || '';
    const arsipDbId = rowData[21];  

    // Ambil Info Kepsek & Nama Mapel
    let kepalaSekolah = '.........................';
    let nipKepsek = '-';
    let jenjang = '';
    let mapelFullName = mapel;
    
    if (app1DbId) {
       try {
         const ss1 = SpreadsheetApp.openById(app1DbId);
         const dsSheet = ss1.getSheetByName('Data_Sekolah');
         if (dsSheet) {
           const val = dsSheet.getRange('A2:P2').getValues()[0];
           jenjang = val[0] || '';
           if(val[14]) kepalaSekolah = val[14];
           if(val[15]) nipKepsek = val[15];
         }

         const mapelSheetRef = ss1.getSheetByName('Mapel');
         if (mapelSheetRef) {
             const dataMapelRef = mapelSheetRef.getDataRange().getValues();
             for(let m=1; m < dataMapelRef.length; m++) {
                 if (String(dataMapelRef[m][0]).trim() === String(mapel).trim()) {
                     mapelFullName = dataMapelRef[m][1];
                     break;
                 }
             }
         }

       } catch(e) { Logger.log("Error ambil data dari App 1: " + e.message); }
    }

    // Ambil Data Nilai
    const ssArsip = SpreadsheetApp.openById(arsipDbId);
    const sheet = ssArsip.getSheetByName(sheetName);
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const idxNo = headers.indexOf('No');
    const idxNama = headers.indexOf('Nama Siswa');
    const idxNisn = headers.indexOf('NISN');
    const idxKelas = headers.indexOf('Kelas');
    const colTarget = `${mapel}_${jenisNilai}`; 
    const idxNilai = headers.indexOf(colTarget);
    
    if (idxNilai === -1) throw new Error(`Data nilai '${colTarget}' tidak ditemukan di arsip.`);
    
    const siswaList = [];
    for (let i = 1; i < data.length; i++) {
       const row = data[i];
       const kelasSiswa = row[idxKelas];
       
       if (filterKelas !== 'semua' && String(kelasSiswa) !== String(filterKelas)) continue;
       
       const nilaiRaw = row[idxNilai];
       let nilaiAngka = '';
       let nilaiHuruf = '';
       
       if (nilaiRaw !== "" && nilaiRaw != null) {
          const num = parseFloat(nilaiRaw);
          nilaiAngka = Math.round(num);
          nilaiHuruf = terbilang(nilaiAngka);
       }
       
       siswaList.push({
         no: row[idxNo],
         nama: row[idxNama],
         nisn: row[idxNisn] ? String(row[idxNisn]).replace("'", "") : "-",
         kelas: kelasSiswa,
         nilai: nilaiAngka,
         huruf: nilaiHuruf
       });
    }
    
    siswaList.sort((a, b) => {
       if (a.kelas < b.kelas) return -1;
       if (a.kelas > b.kelas) return 1;
       return a.nama.localeCompare(b.nama);
    });

    // Generate HTML PDF (Sama seperti sebelumnya)
    let kopBase64 = null;
    let headerHtml = '';

    if (kopFileId) {
        kopBase64 = _getImageAsBase64DataUrl(kopFileId);
    }

    if (kopBase64) {
      headerHtml = `
        <div style="width:100%; text-align:center; margin-bottom:10px; padding-bottom:5px;">
           <img src="${kopBase64}" style="width:680px; display:block; margin:0 auto;" />
        </div>`;
    } else {
      headerHtml = `
        <div style="text-align: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px;">
           <h2 style="margin:0;">${namaSekolah.toUpperCase()}</h2>
        </div>`;
    }
      
    let rowsHtml = '';
    if (siswaList.length === 0) {
      rowsHtml = '<tr><td colspan="6" style="text-align:center; padding:20px;">Tidak ada data.</td></tr>';
    } else {
      siswaList.forEach((s, i) => {
        rowsHtml += `<tr>
          <td style="text-align:center;">${i+1}</td>
          <td style="text-align:center;">${s.nisn}</td>
          <td>${s.nama}</td>
          <td style="text-align:center;">${s.kelas}</td>
          <td style="text-align:center;">${s.nilai}</td>
          <td style="font-style:italic;">${s.huruf}</td>
        </tr>`;
      });
    }
    
    const tglStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    const jabatan = (jenjang.includes('M') || jenjang.includes('MTS') || jenjang.includes('MA')) ? "Kepala Madrasah" : "Kepala Sekolah";
    const tahunAjar = sheetName.replace('Arsip ', '');
    const kepsekFormatted = formatNamaGelar(kepalaSekolah);
    
    const html = `
      <html><head><style>
        @page { size: A4; margin: 1cm; }
        body { font-family: Arial, sans-serif; font-size: 10pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 4px; }
        th { background-color: #e0e0e0; text-align: center; font-weight: bold; }
        .info-table { border: none; margin-bottom: 15px; width: 100%; }
        .info-table td { border: none; padding: 2px; }
      </style></head><body>
        ${headerHtml}
        <div style="text-align:center; margin-bottom:15px;">
           <h3 style="text-decoration:underline; margin:5px;">LAPORAN NILAI ${jenisNilai.toUpperCase()} (ARSIP)</h3>
           <h4 style="margin:5px; font-weight:bold;">${namaSekolah.toUpperCase()}</h4>
           <p style="margin:0;">Tahun Ajaran: ${tahunAjar}</p>
        </div>
        <table class="info-table">
           <tr><td width="120">Mata Pelajaran</td><td>: <strong>${mapelFullName.toUpperCase()}</strong></td></tr>
           <tr><td>Kelas</td><td>: <strong>${filterKelas === 'semua' ? 'Semua Kelas' : filterKelas}</strong></td></tr>
        </table>
        <table>
           <thead>
             <tr><th width="30">No</th><th width="80">NISN</th><th>Nama Siswa</th><th width="60">Kelas</th><th width="50">Nilai</th><th>Terbilang</th></tr>
           </thead>
           <tbody>${rowsHtml}</tbody>
        </table>
        <div style="margin-top:30px; float:right; width:250px; text-align:center;">
           ${tempatTtd}, ${tglStr}<br>
           Mengetahui,<br>${jabatan}<br><br><br><br>
           <strong><u>${kepsekFormatted}</u></strong><br>NIP. ${nipKepsek}
        </div>
      </body></html>
    `;
    
    const blob = Utilities.newBlob(html, MimeType.HTML).getAs(MimeType.PDF);
    const b64 = Utilities.base64Encode(blob.getBytes());
    return { success: true, base64Data: b64, fileName: `Arsip_${mapel}_${jenisNilai}_${tahunAjar}.pdf` };

  } catch (e) {
    return { success: false, message: e.message };
  } finally {
    lock.releaseLock();
  }
}

// --- HELPER UTILS (Sama dengan App 2) ---
function _getImageAsBase64DataUrl(fileId) {
  try {
    if (!fileId) return null;
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    const contentType = blob.getContentType();
    const base64 = Utilities.base64Encode(blob.getBytes());
    return `data:${contentType};base64,${base64}`;
  } catch (e) {
    Logger.log(`Gagal mengambil gambar (ID: ${fileId}). Error: ${e.message}`);
    return null;
  }
}

function terbilang(n) {
    if (n < 0 || n > 100 || isNaN(n) || n === '') return '';
    if (n === 100) return 'Seratus';
    if (n === 0) return 'Nol';
    const s = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
    if (n < 12) return s[n];
    if (n < 20) return s[n - 10] + " Belas";
    const p = Math.floor(n / 10);
    const r = n % 10;
    return (s[p] + " Puluh") + (r === 0 ? '' : " " + s[r]);
}

function properCaseGelar(gelarString) {
  if (!gelarString) return '';
  const joiner = gelarString.includes('.') ? ' ' : '.'; 
  return gelarString.split(' ') 
    .map(gelarPart => {
      return gelarPart.split('.') 
        .map(subPart => {
          if (subPart.length === 0) return ''; 
          if (subPart === subPart.toUpperCase()) return subPart; 
          if (subPart.length === 1) return subPart.toUpperCase(); 
          return subPart.charAt(0).toUpperCase() + subPart.slice(1).toLowerCase(); 
        })
        .join('.'); 
    })
    .join(' '); 
}

function formatNamaGelar(namaLengkap) {
  if (!namaLengkap) return '';
  namaLengkap = namaLengkap.trim();
  
  let nama = '';
  let gelar = '';
  
  const commaIndex = namaLengkap.indexOf(',');
  
  if (commaIndex > -1) {
    nama = namaLengkap.substring(0, commaIndex).trim();
    gelar = namaLengkap.substring(commaIndex + 1).trim();
  } else {
    const parts = namaLengkap.split(' ');
    if (parts.length < 2) return namaLengkap.toUpperCase();
    
    let titleStartIndex = -1;
    for (let i = 1; i < parts.length; i++) {
      const part = parts[i];
      const isGelar = part.includes('.') || 
                      (part.length >= 1 && part.length <= 3 && part === part.toUpperCase());
                      
      if (isGelar) {
        titleStartIndex = i;
        break;
      }
    }

    if (titleStartIndex > -1) {
      nama = parts.slice(0, titleStartIndex).join(' ');
      gelar = parts.slice(titleStartIndex).join(' ');
    } else {
      nama = namaLengkap;
      gelar = '';
    }
  }

  if (gelar) {
    return nama.toUpperCase() + ', ' + properCaseGelar(gelar);
  } else {
    return nama.toUpperCase();
  }
}
